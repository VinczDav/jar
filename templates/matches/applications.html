{% extends 'base.html' %}

{% block title %}Jelentkezések{% endblock %}
{% block page_title %}Jelentkezések{% endblock %}

{% block extra_css %}
<style>
    /* Tabs */
    .tabs-wrapper {
        display: flex;
        gap: 0.5rem;
        background: var(--card-bg);
        padding: 0.5rem;
        border-radius: 8px;
        border: 1px solid var(--border-color);
        margin-bottom: 1.5rem;
    }
    .tab-btn {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        padding: 0.75rem 1.5rem;
        border-radius: 6px;
        text-decoration: none;
        color: var(--text-secondary);
        font-weight: 500;
        transition: all 0.15s ease;
        cursor: pointer;
        border: none;
        background: transparent;
    }
    .tab-btn:hover {
        background: var(--bg-color);
        color: var(--text-primary);
    }
    .tab-btn.active {
        background: var(--primary-color);
        color: white;
    }
    .tab-btn .material-icons {
        font-size: 1.25rem;
    }
    .tab-btn .badge {
        background: rgba(255,255,255,0.2);
        padding: 0.125rem 0.5rem;
        border-radius: 10px;
        font-size: 0.75rem;
    }
    .tab-btn:not(.active) .badge {
        background: var(--border-color);
    }

    .tab-content {
        display: none;
    }
    .tab-content.active {
        display: block;
    }

    /* Match Cards - same style as my_matches page */
    .match-card {
        background: var(--card-bg);
        border-radius: 12px;
        padding: 1rem 1.25rem;
        margin-bottom: 0.75rem;
        border-left: 4px solid var(--text-secondary);
        box-shadow: 0 1px 3px rgba(0,0,0,0.08);
    }
    .match-card.can-apply {
        border-left-color: var(--warning-color);
        background: linear-gradient(to right, rgba(255, 193, 7, 0.05), transparent);
    }
    .match-card.applied {
        border-left-color: var(--primary-color);
        background: linear-gradient(to right, rgba(99, 102, 241, 0.05), transparent);
    }

    .match-card-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        margin-bottom: 1rem;
    }
    .match-card-teams {
        display: flex;
        align-items: center;
        gap: 1rem;
        flex: 1;
    }
    .team-info {
        display: flex;
        align-items: center;
        gap: 0.75rem;
    }
    .team-logo {
        width: 44px;
        height: 44px;
        object-fit: contain;
        border-radius: 6px;
        background: var(--bg-color);
    }
    .team-logo-placeholder {
        width: 44px;
        height: 44px;
        border-radius: 6px;
        background: var(--border-color);
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 0.75rem;
        font-weight: 600;
        color: var(--text-secondary);
    }
    .team-name {
        font-weight: 600;
        font-size: 1.15rem;
    }
    .vs-separator {
        color: var(--text-secondary);
        font-size: 1.1rem;
        padding: 0 0.5rem;
        font-weight: 600;
    }
    .match-card-meta {
        display: flex;
        align-items: center;
        gap: 1.25rem;
        flex-shrink: 0;
    }
    .match-datetime {
        display: flex;
        align-items: center;
        gap: 0.75rem;
        font-size: 1.1rem;
        white-space: nowrap;
    }
    .match-date {
        color: var(--text-secondary);
        font-size: 1.1rem;
    }
    .match-time {
        font-weight: 700;
        color: var(--text-primary);
        font-size: 1.25rem;
    }
    .match-competition {
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }
    .competition-badge {
        padding: 0.25rem 0.6rem;
        border-radius: 6px;
        font-size: 0.8rem;
        font-weight: 600;
        color: white !important;
        white-space: nowrap;
    }
    .match-venue {
        font-size: 1rem;
        color: var(--text-primary);
        display: flex;
        align-items: center;
        gap: 0.35rem;
        font-weight: 500;
    }
    .match-venue .material-icons {
        font-size: 1.1rem;
        color: var(--accent-color);
    }
    .tournament-badge {
        background: #7c3aed;
        color: white;
        padding: 0.35rem 0.75rem;
        border-radius: 8px;
        font-size: 0.9rem;
        font-weight: 600;
        display: inline-flex;
        align-items: center;
        gap: 0.35rem;
    }
    .tournament-badge .material-icons {
        font-size: 1.1rem;
    }

    .match-card-footer {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding-top: 1rem;
        border-top: 1px solid var(--border-color);
        margin-top: 0.75rem;
    }
    .match-referees-row {
        display: flex;
        flex-wrap: wrap;
        gap: 0.75rem 2.5rem;
        font-size: 1rem;
    }
    .referee-item {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        padding: 0.25rem 0;
    }
    .referee-role {
        color: var(--text-secondary);
        font-weight: 500;
        min-width: 90px;
    }
    .referee-name {
        color: var(--text-primary);
        font-weight: 600;
    }

    /* Response status icons */
    .response-status-icon {
        font-size: 1.25rem;
    }
    .response-status-icon.response-accepted {
        color: var(--success-color);
    }
    .response-status-icon.response-pending {
        color: var(--warning-color);
    }
    .response-status-icon.response-declined {
        color: var(--danger-color);
    }

    .match-actions {
        display: flex;
        gap: 0.5rem;
        align-items: center;
        flex-wrap: wrap;
    }
    .match-actions .btn {
        padding: 0.5rem 1rem;
        border-radius: 6px;
        font-size: 0.85rem;
        font-weight: 500;
        display: inline-flex;
        align-items: center;
        gap: 0.25rem;
        cursor: pointer;
        border: none;
        transition: all 0.15s;
    }
    .match-actions .btn .material-icons {
        font-size: 1rem;
    }
    .btn-apply {
        background: var(--primary-color);
        color: white;
        padding: 0.5rem 1rem;
    }
    .btn-apply:hover {
        background: #4f46e5;
    }
    .btn-withdraw {
        background: var(--danger-color);
        color: white;
    }
    .btn-withdraw:hover {
        background: #c82333;
    }

    .role-badge {
        display: flex;
        align-items: center;
        gap: 0.35rem;
        font-size: 0.8rem;
        padding: 0.25rem 0.6rem;
        border-radius: 20px;
        font-weight: 500;
    }
    .role-badge.referee {
        background: rgba(25, 118, 210, 0.15);
        color: #1976d2;
    }
    .role-badge.inspector {
        background: rgba(245, 124, 0, 0.15);
        color: #f57c00;
    }
    .role-badge.tournament_director {
        background: rgba(56, 142, 60, 0.15);
        color: #388e3c;
    }

    .empty-state {
        text-align: center;
        padding: 3rem;
        color: var(--text-secondary);
        background: var(--card-bg);
        border-radius: 12px;
    }
    .empty-state .material-icons {
        font-size: 3rem;
        opacity: 0.5;
        margin-bottom: 1rem;
    }
    .empty-state p {
        margin: 0;
    }

    .info-banner {
        background: var(--card-bg);
        border: 1px solid var(--border-color);
        border-radius: 8px;
        padding: 1rem;
        margin-bottom: 1.5rem;
        display: flex;
        align-items: center;
        gap: 0.75rem;
    }
    .info-banner .material-icons {
        color: var(--primary-color);
    }
    .info-banner p {
        margin: 0;
        color: var(--text-secondary);
        font-size: 0.9rem;
    }

    .role-selector {
        display: flex;
        gap: 0.5rem;
        flex-wrap: wrap;
    }

    /* Filters */
    .filter-form {
        display: flex;
        flex-wrap: wrap;
        gap: 1rem;
        margin-bottom: 1.5rem;
        padding: 1rem;
        background: var(--card-bg);
        border: 1px solid var(--border-color);
        border-radius: 8px;
        align-items: flex-end;
    }
    .filter-group {
        display: flex;
        flex-direction: column;
        gap: 0.25rem;
    }
    .filter-group label {
        font-size: 0.75rem;
        font-weight: 500;
        color: var(--text-secondary);
    }
    .filter-group select,
    .filter-group input {
        padding: 0.5rem 0.75rem;
        border: 1px solid var(--border-color);
        border-radius: 6px;
        background: var(--bg-color);
        color: var(--text-primary);
        min-width: 150px;
    }
    .filter-buttons {
        display: flex;
        gap: 0.5rem;
        align-items: flex-end;
    }

    /* Mobile Responsive */
    @media (max-width: 768px) {
        .filter-form {
            flex-direction: column;
            gap: 0.75rem;
        }
        .filter-group {
            width: 100%;
        }
        .filter-group select,
        .filter-group input {
            width: 100%;
            min-width: unset;
        }
        .filter-buttons {
            width: 100%;
            justify-content: stretch;
        }
        .filter-buttons .btn {
            flex: 1;
        }
        .tabs-wrapper {
            width: 100%;
        }
        .tab-btn {
            flex: 1;
            justify-content: center;
            padding: 0.6rem 0.75rem;
            font-size: 0.85rem;
        }
        .tab-btn .material-icons {
            font-size: 1.1rem;
        }

        /* Match card mobile layout */
        .match-card {
            padding: 0.75rem 1rem;
        }
        .match-card-header {
            flex-direction: column;
            align-items: stretch;
            gap: 0.75rem;
            margin-bottom: 0.75rem;
        }
        .match-card-teams {
            flex-wrap: wrap;
            gap: 0.35rem;
        }
        .team-info {
            gap: 0.35rem;
        }
        .team-logo, .team-logo-placeholder {
            width: 32px;
            height: 32px;
            font-size: 0.65rem;
        }
        .team-name {
            font-size: 0.95rem;
        }
        .vs-separator {
            padding: 0 0.25rem;
            font-size: 0.9rem;
        }
        .match-card-meta {
            flex-wrap: wrap;
            gap: 0.5rem 0.75rem;
        }
        .match-datetime {
            font-size: 0.9rem;
            gap: 0.35rem;
        }
        .match-date {
            font-size: 0.9rem;
        }
        .match-time {
            font-size: 1rem;
        }
        .match-venue {
            font-size: 0.85rem;
            max-width: 100%;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        .competition-badge {
            font-size: 0.7rem;
            padding: 0.2rem 0.4rem;
        }

        /* Match card footer mobile */
        .match-card-footer {
            flex-direction: column;
            align-items: stretch;
            gap: 0.75rem;
            padding-top: 0.75rem;
        }
        .match-referees-row {
            gap: 0.35rem 1rem;
        }
        .referee-item {
            font-size: 0.85rem;
        }
        .referee-role {
            min-width: 70px;
            font-size: 0.8rem;
        }
        .response-status-icon {
            font-size: 1rem;
        }

        /* Actions mobile */
        .match-actions {
            flex-direction: column;
            gap: 0.5rem;
            width: 100%;
        }
        .role-selector {
            width: 100%;
            flex-direction: column;
        }
        .role-selector .btn {
            width: 100%;
            justify-content: center;
        }

        /* Empty state mobile */
        .empty-state {
            padding: 2rem 1rem;
        }
        .empty-state .material-icons {
            font-size: 2.5rem;
        }
    }

    @media (max-width: 480px) {
        .match-card-teams {
            flex-direction: column;
            align-items: flex-start;
        }
        .vs-separator {
            display: none;
        }
        .team-info:not(:first-child)::before {
            content: 'vs ';
            color: var(--text-secondary);
            font-size: 0.75rem;
            margin-right: 0.25rem;
        }
        .match-datetime {
            width: 100%;
            justify-content: space-between;
        }
        .match-venue {
            width: 100%;
        }
        .referee-role {
            display: none;
        }
    }
</style>
{% endblock %}

{% block content %}
{% if not can_apply_as_referee and not can_apply_as_inspector and not can_apply_as_tournament_director %}
<div class="info-banner">
    <span class="material-icons">info</span>
    <p>Jelenleg nincs engedélyezve a meccsekre jelentkezés. Kérdezd meg az adminisztrátort.</p>
</div>
{% else %}

<!-- Tabs -->
<div class="tabs-wrapper">
    <button class="tab-btn active" data-tab="available">
        <span class="material-icons">event_available</span>
        Elérhető meccsek
        <span class="badge">{{ available_matches|length }}</span>
    </button>
    <button class="tab-btn" data-tab="my-applications">
        <span class="material-icons">how_to_reg</span>
        Jelentkezéseim
        <span class="badge">{{ my_applications|length }}</span>
    </button>
</div>

<!-- Filters -->
<form method="get" class="filter-form">
    <div class="filter-group">
        <label>Szezon</label>
        <select id="season" name="season">
            {% for season in seasons %}
            <option value="{{ season.id }}" {% if selected_season.id == season.id %}selected{% endif %}>
                {{ season.name }}
            </option>
            {% endfor %}
        </select>
    </div>
    <div class="filter-group">
        <label>Bajnokság</label>
        <select id="competition" name="competition">
            <option value="">Összes bajnokság</option>
            {% for comp in competitions %}
            <option value="{{ comp.id }}" {% if selected_competition == comp.id|stringformat:"i" %}selected{% endif %}>
                {{ comp.short_name }}
            </option>
            {% endfor %}
        </select>
    </div>
    <div class="filter-group">
        <label>Dátumtól</label>
        <input type="date" id="date_from" name="date_from" value="{{ date_from }}">
    </div>
    <div class="filter-group">
        <label>Dátumig</label>
        <input type="date" id="date_to" name="date_to" value="{{ date_to }}">
    </div>
    <div class="filter-group">
        <label>Csapat</label>
        <select id="team" name="team">
            <option value="">Összes csapat</option>
            {% for team in teams %}
            <option value="{{ team.id }}" {% if selected_team == team.id|stringformat:"i" %}selected{% endif %}>
                {{ team.display_name }}
            </option>
            {% endfor %}
        </select>
    </div>
    <div class="filter-buttons">
        <button type="submit" class="btn btn-primary">
            <span class="material-icons">search</span>
            Szűrés
        </button>
        <a href="{% url 'matches:match_applications' %}" class="btn btn-secondary">
            <span class="material-icons">clear</span>
            Törlés
        </a>
    </div>
</form>

<!-- Available Matches Tab -->
<div id="tab-available" class="tab-content active">
    {% if available_matches %}
        {% for match in available_matches %}
        <div class="match-card can-apply" data-match-id="{{ match.id }}">
            <div class="match-card-header">
                <div class="match-card-teams">
                    <div class="team-info">
                        {% if match.home_team %}
                            {% if match.home_team.effective_logo %}
                            <img src="{{ match.home_team.effective_logo.url }}" alt="" class="team-logo">
                            {% else %}
                            <div class="team-logo-placeholder">{{ match.home_team.short_name|default:match.home_team|slice:":2"|upper }}</div>
                            {% endif %}
                            <span class="team-name">{{ match.home_team.display_name }}</span>
                        {% else %}
                            <div class="team-logo-placeholder">TB</div>
                            <span class="team-name">TBD</span>
                        {% endif %}
                    </div>
                    {% if match.is_tournament %}
                    <span class="tournament-badge">
                        <span class="material-icons">emoji_events</span>
                        Torna
                    </span>
                    {% else %}
                    <span class="vs-separator">-</span>
                    <div class="team-info">
                        {% if match.away_team %}
                            {% if match.away_team.effective_logo %}
                            <img src="{{ match.away_team.effective_logo.url }}" alt="" class="team-logo">
                            {% else %}
                            <div class="team-logo-placeholder">{{ match.away_team.short_name|default:match.away_team|slice:":2"|upper }}</div>
                            {% endif %}
                            <span class="team-name">{{ match.away_team.display_name }}</span>
                        {% else %}
                            <div class="team-logo-placeholder">TB</div>
                            <span class="team-name">TBD</span>
                        {% endif %}
                    </div>
                    {% endif %}
                </div>
                <div class="match-card-meta">
                    {% if match.phase %}
                    <div class="match-competition">
                        <span class="competition-badge" style="background: {{ match.phase.competition.color }};">
                            {{ match.phase.competition.short_name }}
                        </span>
                        <span style="font-size: 0.8rem; color: var(--text-secondary);">{{ match.phase.name }}</span>
                    </div>
                    {% endif %}
                    <div class="match-datetime">
                        <span class="match-date">{{ match.date|date:"Y.m.d" }} ({{ match.date|date:"D" }})</span>
                        <span class="match-time">{{ match.time|time:"H:i" }}</span>
                    </div>
                    {% if match.venue %}
                    <div class="match-venue">
                        <span class="material-icons">location_on</span>
                        {% if match.venue.google_maps_url %}
                        <a href="{{ match.venue.google_maps_url }}" target="_blank" rel="noopener" style="color: inherit; text-decoration: underline; text-decoration-style: dotted;" title="Megnyitás Google Maps-ben">{{ match.venue.name }}</a>{% if match.court %} ({{ match.court }}){% endif %}
                        {% else %}
                        {{ match.venue.name }}{% if match.court %} ({{ match.court }}){% endif %}
                        {% endif %}
                    </div>
                    {% endif %}
                </div>
            </div>
            <div class="match-card-footer">
                <div class="match-referees-row">
                    {% with referees=match.get_referees reserves=match.get_reserves inspectors=match.get_inspectors tournament_directors=match.get_tournament_directors %}
                    {% for ref in referees %}
                    <div class="referee-item">
                        {% if ref.placeholder_type == 'nincs' %}
                        <span class="material-icons response-status-icon" style="color: var(--text-secondary);">block</span>
                        <span class="referee-role">Játékvezető</span>
                        <span class="referee-name" style="color: var(--text-secondary); font-style: italic;">Nincs</span>
                        {% elif ref.placeholder_type == 'szukseges' and not ref.user %}
                        <span class="material-icons response-status-icon" style="color: var(--warning-color);">schedule</span>
                        <span class="referee-role">Játékvezető</span>
                        <span class="referee-name" style="color: var(--warning-color); font-weight: 600;">Szükséges</span>
                        {% elif ref.response_status == 'declined' or ref.placeholder_type == 'hianyzik' %}
                        <span class="material-icons response-status-icon" style="color: var(--danger-color);">error</span>
                        <span class="referee-role">Játékvezető</span>
                        <span class="referee-name" style="color: var(--danger-color); font-weight: 600;">Hiányzik!</span>
                        {% elif ref.user %}
                        <span class="material-icons response-status-icon response-{{ ref.response_status }}">
                            {% if ref.response_status == 'accepted' %}check_circle{% else %}schedule{% endif %}
                        </span>
                        <span class="referee-role">Játékvezető</span>
                        <span class="referee-name">{{ ref.user.get_full_name }}</span>
                        {% else %}
                        <span class="material-icons response-status-icon" style="color: var(--danger-color);">error</span>
                        <span class="referee-role">Játékvezető</span>
                        <span class="referee-name" style="color: var(--danger-color); font-weight: 600;">Hiányzik!</span>
                        {% endif %}
                    </div>
                    {% empty %}
                    <div class="referee-item">
                        <span class="material-icons response-status-icon" style="color: var(--text-secondary);">help_outline</span>
                        <span class="referee-role">Játékvezető</span>
                        <span class="referee-name" style="color: var(--text-secondary); font-style: italic;">Nincs kiírva</span>
                    </div>
                    {% endfor %}
                    {% for ref in reserves %}
                    <div class="referee-item">
                        {% if ref.placeholder_type == 'nincs' %}
                        <span class="material-icons response-status-icon" style="color: var(--text-secondary);">block</span>
                        <span class="referee-role">Tartalék</span>
                        <span class="referee-name" style="color: var(--text-secondary); font-style: italic;">Nincs</span>
                        {% elif ref.placeholder_type == 'szukseges' and not ref.user %}
                        <span class="material-icons response-status-icon" style="color: var(--warning-color);">schedule</span>
                        <span class="referee-role">Tartalék</span>
                        <span class="referee-name" style="color: var(--warning-color); font-weight: 600;">Szükséges</span>
                        {% elif ref.response_status == 'declined' or ref.placeholder_type == 'hianyzik' %}
                        <span class="material-icons response-status-icon" style="color: var(--danger-color);">error</span>
                        <span class="referee-role">Tartalék</span>
                        <span class="referee-name" style="color: var(--danger-color); font-weight: 600;">Hiányzik!</span>
                        {% elif ref.user %}
                        <span class="material-icons response-status-icon response-{{ ref.response_status }}">
                            {% if ref.response_status == 'accepted' %}check_circle{% else %}schedule{% endif %}
                        </span>
                        <span class="referee-role">Tartalék</span>
                        <span class="referee-name">{{ ref.user.get_full_name }}</span>
                        {% else %}
                        <span class="material-icons response-status-icon" style="color: var(--danger-color);">error</span>
                        <span class="referee-role">Tartalék</span>
                        <span class="referee-name" style="color: var(--danger-color); font-weight: 600;">Hiányzik!</span>
                        {% endif %}
                    </div>
                    {% endfor %}
                    {% for ref in inspectors %}
                    <div class="referee-item">
                        {% if ref.placeholder_type == 'nincs' %}
                        <span class="material-icons response-status-icon" style="color: var(--text-secondary);">block</span>
                        <span class="referee-role">Ellenőr</span>
                        <span class="referee-name" style="color: var(--text-secondary); font-style: italic;">Nincs</span>
                        {% elif ref.placeholder_type == 'szukseges' and not ref.user %}
                        <span class="material-icons response-status-icon" style="color: var(--warning-color);">schedule</span>
                        <span class="referee-role">Ellenőr</span>
                        <span class="referee-name" style="color: var(--warning-color); font-weight: 600;">Szükséges</span>
                        {% elif ref.response_status == 'declined' or ref.placeholder_type == 'hianyzik' %}
                        <span class="material-icons response-status-icon" style="color: var(--danger-color);">error</span>
                        <span class="referee-role">Ellenőr</span>
                        <span class="referee-name" style="color: var(--danger-color); font-weight: 600;">Hiányzik!</span>
                        {% elif ref.user %}
                        <span class="material-icons response-status-icon response-{{ ref.response_status }}">
                            {% if ref.response_status == 'accepted' %}check_circle{% else %}schedule{% endif %}
                        </span>
                        <span class="referee-role">Ellenőr</span>
                        <span class="referee-name">{{ ref.user.get_full_name }}</span>
                        {% else %}
                        <span class="material-icons response-status-icon" style="color: var(--danger-color);">error</span>
                        <span class="referee-role">Ellenőr</span>
                        <span class="referee-name" style="color: var(--danger-color); font-weight: 600;">Hiányzik!</span>
                        {% endif %}
                    </div>
                    {% endfor %}
                    {% for ref in tournament_directors %}
                    <div class="referee-item">
                        {% if ref.placeholder_type == 'nincs' %}
                        <span class="material-icons response-status-icon" style="color: var(--text-secondary);">block</span>
                        <span class="referee-role">Tornaig.</span>
                        <span class="referee-name" style="color: var(--text-secondary); font-style: italic;">Nincs</span>
                        {% elif ref.placeholder_type == 'szukseges' and not ref.user %}
                        <span class="material-icons response-status-icon" style="color: var(--warning-color);">schedule</span>
                        <span class="referee-role">Tornaig.</span>
                        <span class="referee-name" style="color: var(--warning-color); font-weight: 600;">Szükséges</span>
                        {% elif ref.response_status == 'declined' or ref.placeholder_type == 'hianyzik' %}
                        <span class="material-icons response-status-icon" style="color: var(--danger-color);">error</span>
                        <span class="referee-role">Tornaig.</span>
                        <span class="referee-name" style="color: var(--danger-color); font-weight: 600;">Hiányzik!</span>
                        {% elif ref.user %}
                        <span class="material-icons response-status-icon response-{{ ref.response_status }}">
                            {% if ref.response_status == 'accepted' %}check_circle{% else %}schedule{% endif %}
                        </span>
                        <span class="referee-role">Tornaig.</span>
                        <span class="referee-name">{{ ref.user.get_full_name }}</span>
                        {% else %}
                        <span class="material-icons response-status-icon" style="color: var(--danger-color);">error</span>
                        <span class="referee-role">Tornaig.</span>
                        <span class="referee-name" style="color: var(--danger-color); font-weight: 600;">Hiányzik!</span>
                        {% endif %}
                    </div>
                    {% endfor %}
                    {% endwith %}
                </div>
                <div class="match-actions">
                    <div class="role-selector">
                        {% if can_apply_as_referee and match.has_open_referee_position %}
                        <button class="btn btn-apply" onclick="applyForMatch({{ match.id }}, 'referee')">
                            <span class="material-icons">sports</span>
                            Jelentkezem JV-nek
                        </button>
                        {% endif %}
                        {% if can_apply_as_inspector and match.has_open_inspector_position %}
                        <button class="btn btn-apply" onclick="applyForMatch({{ match.id }}, 'inspector')">
                            <span class="material-icons">visibility</span>
                            Jelentkezem ellenőrnek
                        </button>
                        {% endif %}
                        {% if can_apply_as_tournament_director and match.has_open_td_position %}
                        <button class="btn btn-apply" onclick="applyForMatch({{ match.id }}, 'tournament_director')">
                            <span class="material-icons">admin_panel_settings</span>
                            Jelentkezem TIG-nek
                        </button>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
        {% endfor %}
    {% else %}
        <div class="empty-state">
            <span class="material-icons">event_busy</span>
            <p>Nincs hova jelentkezni.</p>
        </div>
    {% endif %}
</div>

<!-- My Applications Tab -->
<div id="tab-my-applications" class="tab-content">
    {% if my_applications %}
        {% for app in my_applications %}
        <div class="match-card applied" data-application-id="{{ app.id }}">
            <div class="match-card-header">
                <div class="match-card-teams">
                    <div class="team-info">
                        {% if app.match.home_team %}
                            {% if app.match.home_team.effective_logo %}
                            <img src="{{ app.match.home_team.effective_logo.url }}" alt="" class="team-logo">
                            {% else %}
                            <div class="team-logo-placeholder">{{ app.match.home_team.short_name|default:app.match.home_team|slice:":2"|upper }}</div>
                            {% endif %}
                            <span class="team-name">{{ app.match.home_team.display_name }}</span>
                        {% else %}
                            <div class="team-logo-placeholder">TB</div>
                            <span class="team-name">TBD</span>
                        {% endif %}
                    </div>
                    {% if app.match.is_tournament %}
                    <span class="tournament-badge">
                        <span class="material-icons">emoji_events</span>
                        Torna
                    </span>
                    {% else %}
                    <span class="vs-separator">-</span>
                    <div class="team-info">
                        {% if app.match.away_team %}
                            {% if app.match.away_team.effective_logo %}
                            <img src="{{ app.match.away_team.effective_logo.url }}" alt="" class="team-logo">
                            {% else %}
                            <div class="team-logo-placeholder">{{ app.match.away_team.short_name|default:app.match.away_team|slice:":2"|upper }}</div>
                            {% endif %}
                            <span class="team-name">{{ app.match.away_team.display_name }}</span>
                        {% else %}
                            <div class="team-logo-placeholder">TB</div>
                            <span class="team-name">TBD</span>
                        {% endif %}
                    </div>
                    {% endif %}
                </div>
                <div class="match-card-meta">
                    {% if app.match.phase %}
                    <div class="match-competition">
                        <span class="competition-badge" style="background: {{ app.match.phase.competition.color }};">
                            {{ app.match.phase.competition.short_name }}
                        </span>
                        <span style="font-size: 0.8rem; color: var(--text-secondary);">{{ app.match.phase.name }}</span>
                    </div>
                    {% endif %}
                    <div class="match-datetime">
                        <span class="match-date">{{ app.match.date|date:"Y.m.d" }} ({{ app.match.date|date:"D" }})</span>
                        <span class="match-time">{{ app.match.time|time:"H:i" }}</span>
                    </div>
                    {% if app.match.venue %}
                    <div class="match-venue">
                        <span class="material-icons">location_on</span>
                        {% if app.match.venue.google_maps_url %}
                        <a href="{{ app.match.venue.google_maps_url }}" target="_blank" rel="noopener" style="color: inherit; text-decoration: underline; text-decoration-style: dotted;" title="Megnyitás Google Maps-ben">{{ app.match.venue.name }}</a>{% if app.match.court %} ({{ app.match.court }}){% endif %}
                        {% else %}
                        {{ app.match.venue.name }}{% if app.match.court %} ({{ app.match.court }}){% endif %}
                        {% endif %}
                    </div>
                    {% endif %}
                </div>
            </div>
            <div class="match-card-footer">
                <div class="match-referees-row">
                    {% with referees=app.match.get_referees reserves=app.match.get_reserves inspectors=app.match.get_inspectors tournament_directors=app.match.get_tournament_directors %}
                    {% for ref in referees %}
                    <div class="referee-item">
                        {% if ref.placeholder_type == 'nincs' %}
                        <span class="material-icons response-status-icon" style="color: var(--text-secondary);">block</span>
                        <span class="referee-role">Játékvezető</span>
                        <span class="referee-name" style="color: var(--text-secondary); font-style: italic;">Nincs</span>
                        {% elif ref.placeholder_type == 'szukseges' and not ref.user %}
                        <span class="material-icons response-status-icon" style="color: var(--warning-color);">schedule</span>
                        <span class="referee-role">Játékvezető</span>
                        <span class="referee-name" style="color: var(--warning-color); font-weight: 600;">Szükséges</span>
                        {% elif ref.response_status == 'declined' or ref.placeholder_type == 'hianyzik' %}
                        <span class="material-icons response-status-icon" style="color: var(--danger-color);">error</span>
                        <span class="referee-role">Játékvezető</span>
                        <span class="referee-name" style="color: var(--danger-color); font-weight: 600;">Hiányzik!</span>
                        {% elif ref.user %}
                        <span class="material-icons response-status-icon response-{{ ref.response_status }}">
                            {% if ref.response_status == 'accepted' %}check_circle{% else %}schedule{% endif %}
                        </span>
                        <span class="referee-role">Játékvezető</span>
                        <span class="referee-name">{{ ref.user.get_full_name }}</span>
                        {% else %}
                        <span class="material-icons response-status-icon" style="color: var(--danger-color);">error</span>
                        <span class="referee-role">Játékvezető</span>
                        <span class="referee-name" style="color: var(--danger-color); font-weight: 600;">Hiányzik!</span>
                        {% endif %}
                    </div>
                    {% empty %}
                    <div class="referee-item">
                        <span class="material-icons response-status-icon" style="color: var(--text-secondary);">help_outline</span>
                        <span class="referee-role">Játékvezető</span>
                        <span class="referee-name" style="color: var(--text-secondary); font-style: italic;">Nincs kiírva</span>
                    </div>
                    {% endfor %}
                    {% for ref in reserves %}
                    <div class="referee-item">
                        {% if ref.placeholder_type == 'nincs' %}
                        <span class="material-icons response-status-icon" style="color: var(--text-secondary);">block</span>
                        <span class="referee-role">Tartalék</span>
                        <span class="referee-name" style="color: var(--text-secondary); font-style: italic;">Nincs</span>
                        {% elif ref.placeholder_type == 'szukseges' and not ref.user %}
                        <span class="material-icons response-status-icon" style="color: var(--warning-color);">schedule</span>
                        <span class="referee-role">Tartalék</span>
                        <span class="referee-name" style="color: var(--warning-color); font-weight: 600;">Szükséges</span>
                        {% elif ref.response_status == 'declined' or ref.placeholder_type == 'hianyzik' %}
                        <span class="material-icons response-status-icon" style="color: var(--danger-color);">error</span>
                        <span class="referee-role">Tartalék</span>
                        <span class="referee-name" style="color: var(--danger-color); font-weight: 600;">Hiányzik!</span>
                        {% elif ref.user %}
                        <span class="material-icons response-status-icon response-{{ ref.response_status }}">
                            {% if ref.response_status == 'accepted' %}check_circle{% else %}schedule{% endif %}
                        </span>
                        <span class="referee-role">Tartalék</span>
                        <span class="referee-name">{{ ref.user.get_full_name }}</span>
                        {% else %}
                        <span class="material-icons response-status-icon" style="color: var(--danger-color);">error</span>
                        <span class="referee-role">Tartalék</span>
                        <span class="referee-name" style="color: var(--danger-color); font-weight: 600;">Hiányzik!</span>
                        {% endif %}
                    </div>
                    {% endfor %}
                    {% for ref in inspectors %}
                    <div class="referee-item">
                        {% if ref.placeholder_type == 'nincs' %}
                        <span class="material-icons response-status-icon" style="color: var(--text-secondary);">block</span>
                        <span class="referee-role">Ellenőr</span>
                        <span class="referee-name" style="color: var(--text-secondary); font-style: italic;">Nincs</span>
                        {% elif ref.placeholder_type == 'szukseges' and not ref.user %}
                        <span class="material-icons response-status-icon" style="color: var(--warning-color);">schedule</span>
                        <span class="referee-role">Ellenőr</span>
                        <span class="referee-name" style="color: var(--warning-color); font-weight: 600;">Szükséges</span>
                        {% elif ref.response_status == 'declined' or ref.placeholder_type == 'hianyzik' %}
                        <span class="material-icons response-status-icon" style="color: var(--danger-color);">error</span>
                        <span class="referee-role">Ellenőr</span>
                        <span class="referee-name" style="color: var(--danger-color); font-weight: 600;">Hiányzik!</span>
                        {% elif ref.user %}
                        <span class="material-icons response-status-icon response-{{ ref.response_status }}">
                            {% if ref.response_status == 'accepted' %}check_circle{% else %}schedule{% endif %}
                        </span>
                        <span class="referee-role">Ellenőr</span>
                        <span class="referee-name">{{ ref.user.get_full_name }}</span>
                        {% else %}
                        <span class="material-icons response-status-icon" style="color: var(--danger-color);">error</span>
                        <span class="referee-role">Ellenőr</span>
                        <span class="referee-name" style="color: var(--danger-color); font-weight: 600;">Hiányzik!</span>
                        {% endif %}
                    </div>
                    {% endfor %}
                    {% for ref in tournament_directors %}
                    <div class="referee-item">
                        {% if ref.placeholder_type == 'nincs' %}
                        <span class="material-icons response-status-icon" style="color: var(--text-secondary);">block</span>
                        <span class="referee-role">Tornaig.</span>
                        <span class="referee-name" style="color: var(--text-secondary); font-style: italic;">Nincs</span>
                        {% elif ref.placeholder_type == 'szukseges' and not ref.user %}
                        <span class="material-icons response-status-icon" style="color: var(--warning-color);">schedule</span>
                        <span class="referee-role">Tornaig.</span>
                        <span class="referee-name" style="color: var(--warning-color); font-weight: 600;">Szükséges</span>
                        {% elif ref.response_status == 'declined' or ref.placeholder_type == 'hianyzik' %}
                        <span class="material-icons response-status-icon" style="color: var(--danger-color);">error</span>
                        <span class="referee-role">Tornaig.</span>
                        <span class="referee-name" style="color: var(--danger-color); font-weight: 600;">Hiányzik!</span>
                        {% elif ref.user %}
                        <span class="material-icons response-status-icon response-{{ ref.response_status }}">
                            {% if ref.response_status == 'accepted' %}check_circle{% else %}schedule{% endif %}
                        </span>
                        <span class="referee-role">Tornaig.</span>
                        <span class="referee-name">{{ ref.user.get_full_name }}</span>
                        {% else %}
                        <span class="material-icons response-status-icon" style="color: var(--danger-color);">error</span>
                        <span class="referee-role">Tornaig.</span>
                        <span class="referee-name" style="color: var(--danger-color); font-weight: 600;">Hiányzik!</span>
                        {% endif %}
                    </div>
                    {% endfor %}
                    {% endwith %}
                </div>
                <div class="match-actions">
                    <span class="role-badge {{ app.role }}">
                        {% if app.role == 'referee' %}
                        <span class="material-icons" style="font-size: 1rem;">sports</span>
                        {% elif app.role == 'inspector' %}
                        <span class="material-icons" style="font-size: 1rem;">visibility</span>
                        {% else %}
                        <span class="material-icons" style="font-size: 1rem;">admin_panel_settings</span>
                        {% endif %}
                        {{ app.get_role_display }}
                    </span>
                    <button class="btn btn-withdraw" onclick="withdrawApplication({{ app.id }})">
                        <span class="material-icons">close</span>
                        Visszavonás
                    </button>
                </div>
            </div>
        </div>
        {% endfor %}
    {% else %}
        <div class="empty-state">
            <span class="material-icons">how_to_reg</span>
            <p>Még nem jelentkeztél semmilyen meccsre.</p>
        </div>
    {% endif %}
</div>

{% endif %}

<script>
// Tab switching
document.querySelectorAll('.tab-btn').forEach(btn => {
    btn.addEventListener('click', function() {
        // Remove active from all tabs and contents
        document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
        document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));

        // Activate clicked tab
        this.classList.add('active');
        document.getElementById('tab-' + this.dataset.tab).classList.add('active');
    });
});

async function applyForMatch(matchId, role) {
    if (!confirm('Biztosan jelentkezel erre a meccsre?')) return;

    try {
        const response = await fetch(`/matches/api/match/${matchId}/apply/`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': '{{ csrf_token }}'
            },
            body: JSON.stringify({ role: role })
        });

        const result = await response.json();

        if (result.success) {
            // Reload to update the lists
            window.location.reload();
        } else {
            alert('Hiba: ' + result.error);
        }
    } catch (error) {
        alert('Hiba történt: ' + error.message);
    }
}

async function withdrawApplication(applicationId) {
    if (!confirm('Biztosan visszavonod a jelentkezést?')) return;

    try {
        const response = await fetch(`/matches/api/application/${applicationId}/withdraw/`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': '{{ csrf_token }}'
            }
        });

        const result = await response.json();

        if (result.success) {
            // Reload to update the lists
            window.location.reload();
        } else {
            alert('Hiba: ' + result.error);
        }
    } catch (error) {
        alert('Hiba történt: ' + error.message);
    }
}
</script>
{% endblock %}
