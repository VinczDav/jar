{% extends 'base.html' %}
{% load static %}

{% block title %}Kiírások{% endblock %}
{% block page_title %}Mérkőzés kiírások{% endblock %}

{% block extra_css %}
<style>
    /* Tab buttons */
    .tab-btn {
        display: inline-flex;
        align-items: center;
        gap: 0.375rem;
        padding: 0.5rem 1rem;
        border-radius: 0.5rem;
        background: var(--card-bg);
        color: var(--text-secondary);
        text-decoration: none;
        font-weight: 500;
        font-size: 0.875rem;
        transition: all 0.15s;
        border: 1px solid var(--border-color);
    }
    .tab-btn:hover {
        background: var(--bg-color);
        color: var(--text-primary);
    }
    .tab-btn.active {
        background: var(--primary-color);
        color: white;
        border-color: var(--primary-color);
    }
    .tab-btn .material-icons {
        font-size: 1.125rem;
    }

    .page-layout {
        display: flex;
        gap: 0;
        height: calc(100vh - 150px);
        margin: -1.5rem;
    }
    .matches-list-panel {
        flex: 1;
        overflow-y: auto;
        padding: 1.5rem;
        background: var(--bg-color);
    }
    .sidebar-panel {
        width: 400px;
        background: var(--card-bg);
        border-left: 1px solid var(--border-color);
        display: none;
        flex-direction: column;
        overflow: hidden;
    }
    .sidebar-panel.open {
        display: flex;
    }
    .sidebar-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 1rem 1.25rem;
        border-bottom: 1px solid var(--border-color);
        background: var(--bg-color);
    }
    .sidebar-title {
        font-weight: 600;
        font-size: 1.1rem;
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }
    .sidebar-close {
        background: none;
        border: none;
        font-size: 1.5rem;
        cursor: pointer;
        color: var(--text-secondary);
        line-height: 1;
        padding: 0.25rem;
    }
    .sidebar-close:hover {
        color: var(--text-primary);
    }
    .sidebar-content {
        flex: 1;
        overflow-y: auto;
        padding: 1.25rem;
    }
    .sidebar-actions {
        padding: 0.75rem 1rem;
        border-top: 1px solid var(--border-color);
        background: var(--bg-color);
        display: flex;
        gap: 0.4rem;
        flex-wrap: nowrap;
        align-items: center;
    }
    .sidebar-actions .btn-sm {
        padding: 0.4rem 0.6rem;
        font-size: 0.8rem;
        white-space: nowrap;
    }
    .sidebar-actions .btn-sm .material-icons {
        font-size: 1rem;
    }

    /* Match info summary in sidebar */
    .match-summary {
        background: var(--bg-color);
        border-radius: 10px;
        padding: 1rem;
        margin-bottom: 1.25rem;
    }
    .match-summary-header {
        display: flex;
        align-items: center;
        gap: 0.75rem;
        margin-bottom: 0.75rem;
    }
    .match-summary-teams {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        font-weight: 600;
        font-size: 1rem;
    }
    .match-summary-teams .team-logo {
        width: 28px;
        height: 28px;
        object-fit: contain;
    }
    .match-summary-meta {
        display: flex;
        flex-wrap: wrap;
        gap: 0.5rem 1rem;
        font-size: 0.85rem;
        color: var(--text-secondary);
    }
    .match-summary-meta span {
        display: flex;
        align-items: center;
        gap: 0.25rem;
    }
    .match-summary-meta .material-icons {
        font-size: 1rem;
    }

    /* Section labels */
    .section-label {
        font-weight: 600;
        font-size: 0.85rem;
        color: var(--text-secondary);
        text-transform: uppercase;
        letter-spacing: 0.5px;
        margin: 1.25rem 0 0.75rem;
        padding-bottom: 0.5rem;
        border-bottom: 1px solid var(--border-color);
    }
    .section-label:first-child {
        margin-top: 0;
    }

    /* Assignment rows */
    .assignment-row {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        margin-bottom: 0.5rem;
    }
    .assignment-row .custom-select-wrapper {
        flex: 1;
    }
    .assignment-row .remove-btn {
        padding: 0.35rem;
        background: none;
        border: none;
        color: var(--text-secondary);
        cursor: pointer;
        border-radius: 4px;
        flex-shrink: 0;
    }
    .assignment-row .remove-btn:hover {
        background: #fee2e2;
        color: var(--danger-color);
    }
    .add-assignment-btn {
        display: flex;
        align-items: center;
        gap: 0.25rem;
        padding: 0.35rem 0.5rem;
        font-size: 0.85rem;
        color: var(--accent-color);
        background: none;
        border: 1px dashed var(--border-color);
        border-radius: 6px;
        cursor: pointer;
        margin-top: 0.5rem;
    }
    .add-assignment-btn:hover {
        border-color: var(--accent-color);
        background: rgba(99, 102, 241, 0.05);
    }

    /* Add Section - grouped at bottom */
    .add-section {
        margin-top: 1rem;
        padding-top: 1rem;
        border-top: 1px solid var(--border-color);
    }
    .add-buttons-grid {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 0.5rem;
    }
    .add-btn-compact {
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 0.25rem;
        padding: 0.5rem 0.75rem;
        font-size: 0.8rem;
        color: var(--text-secondary);
        background: var(--bg-color);
        border: 1px solid var(--border-color);
        border-radius: 6px;
        cursor: pointer;
        transition: all 0.15s;
    }
    .add-btn-compact .material-icons {
        font-size: 1rem;
    }
    .add-btn-compact:hover {
        border-color: var(--accent-color);
        color: var(--accent-color);
        background: rgba(99, 102, 241, 0.05);
    }

    /* Custom Select Dropdown */
    .custom-select-wrapper {
        position: relative;
    }
    .custom-select {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 0.5rem 0.75rem;
        border: 1px solid var(--border-color);
        border-radius: 6px;
        background: var(--card-bg);
        cursor: pointer;
        transition: all 0.2s;
        min-height: 38px;
    }
    .custom-select:hover {
        border-color: var(--accent-color);
    }
    .custom-select.open {
        border-color: var(--accent-color);
        border-bottom-left-radius: 0;
        border-bottom-right-radius: 0;
    }
    .custom-select-value {
        flex: 1;
        font-size: 0.9rem;
        color: var(--text-primary);
    }
    .custom-select-value.placeholder {
        color: var(--text-secondary);
    }
    .custom-select-arrow {
        color: var(--text-secondary);
        transition: transform 0.2s;
    }
    .custom-select.open .custom-select-arrow {
        transform: rotate(180deg);
    }
    .custom-select-dropdown {
        position: absolute;
        top: 100%;
        left: 0;
        right: 0;
        max-height: 200px;
        overflow-y: auto;
        background: var(--card-bg);
        border: 1px solid var(--accent-color);
        border-top: none;
        border-bottom-left-radius: 6px;
        border-bottom-right-radius: 6px;
        z-index: 1000;
        display: none;
        box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    }
    .custom-select-dropdown.show {
        display: block;
    }
    .custom-select-option {
        padding: 0.5rem 0.75rem;
        cursor: pointer;
        font-size: 0.9rem;
        transition: background 0.15s;
    }
    .custom-select-option:hover {
        background: var(--bg-color);
    }
    .custom-select-option.selected {
        background: rgba(99, 102, 241, 0.1);
        color: var(--accent-color);
    }
    .custom-select-search {
        padding: 0.5rem 0.75rem;
        border-bottom: 1px solid var(--border-color);
        position: sticky;
        top: 0;
        background: var(--card-bg);
    }
    .custom-select-search input {
        width: 100%;
        padding: 0.4rem 0.5rem;
        border: 1px solid var(--border-color);
        border-radius: 4px;
        font-size: 0.85rem;
        background: var(--bg-color);
        color: var(--text-primary);
    }
    .custom-select-search input:focus {
        outline: none;
        border-color: var(--accent-color);
    }
    .custom-select-option.tbd-option {
        color: var(--warning-color);
        font-weight: 600;
        border-bottom: 1px solid var(--border-color);
    }

    /* Form elements */
    .form-group {
        margin-bottom: 1rem;
    }
    .form-group label {
        display: block;
        font-weight: 500;
        margin-bottom: 0.4rem;
        font-size: 0.9rem;
        color: var(--text-primary);
    }
    .form-group textarea {
        width: 100%;
        padding: 0.5rem 0.75rem;
        border: 1px solid var(--border-color);
        border-radius: 6px;
        font-size: 0.9rem;
        background: var(--card-bg);
        color: var(--text-primary);
        resize: vertical;
    }
    .form-group textarea:focus {
        outline: none;
        border-color: var(--accent-color);
    }

    /* Response status icons */
    .response-status-icon {
        font-size: 1.25rem;
        flex-shrink: 0;
    }
    .response-draft { color: var(--text-secondary); }
    .response-pending { color: var(--warning-color); }
    .response-accepted { color: var(--success-color); }
    .response-declined { color: var(--danger-color); }
    .response-status-icon.clickable {
        cursor: pointer;
        transition: transform 0.15s, color 0.15s;
    }
    .response-status-icon.clickable:hover {
        transform: scale(1.2);
        color: var(--success-color);
    }

    /* Toast Notification */
    .toast-notification {
        position: fixed;
        bottom: 2rem;
        left: 50%;
        transform: translateX(-50%) translateY(100px);
        background: var(--card-bg);
        color: var(--text-primary);
        padding: 0.75rem 1.5rem;
        border-radius: 8px;
        box-shadow: 0 4px 20px rgba(0,0,0,0.2);
        z-index: 10000;
        display: flex;
        align-items: center;
        gap: 0.5rem;
        font-weight: 500;
        opacity: 0;
        transition: all 0.3s ease;
        border-left: 4px solid var(--success-color);
    }
    .toast-notification.show {
        transform: translateX(-50%) translateY(0);
        opacity: 1;
    }
    .toast-notification.error {
        border-left-color: var(--danger-color);
    }
    .toast-notification .material-icons {
        font-size: 1.25rem;
    }
    .toast-notification.success .material-icons {
        color: var(--success-color);
    }
    .toast-notification.error .material-icons {
        color: var(--danger-color);
    }

    /* Match Cards */
    .card-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 1rem;
    }
    .match-card {
        background: var(--card-bg);
        border-radius: 12px;
        padding: 1rem 1.25rem;
        margin-bottom: 0.75rem;
        border-left: 4px solid var(--text-secondary);
        transition: all 0.2s;
        box-shadow: 0 1px 3px rgba(0,0,0,0.08);
        cursor: pointer;
    }
    .match-card:hover {
        box-shadow: 0 4px 12px rgba(0,0,0,0.12);
        transform: translateY(-1px);
    }
    .match-card.selected {
        box-shadow: 0 4px 12px rgba(99, 102, 241, 0.25);
        border-left-color: var(--accent-color);
    }
    .match-card.status-draft {
        border-left-color: var(--text-secondary);
    }
    .match-card.status-scheduled {
        border-left-color: var(--warning-color);
        background: linear-gradient(to right, rgba(255, 193, 7, 0.05), transparent);
    }
    .match-card.status-confirmed {
        border-left-color: var(--success-color);
        background: linear-gradient(to right, rgba(40, 167, 69, 0.05), transparent);
    }
    .match-card.status-cancelled {
        border-left-color: var(--danger-color);
        background: linear-gradient(to right, rgba(220, 53, 69, 0.08), transparent);
        opacity: 0.8;
    }
    .match-card.status-cancelled .team-name {
        text-decoration: line-through;
        color: var(--text-secondary);
    }

    .match-card-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        margin-bottom: 1rem;
    }
    .match-card-teams {
        display: flex;
        align-items: center;
        gap: 1rem;
        flex: 1;
    }
    .team-info {
        display: flex;
        align-items: center;
        gap: 0.75rem;
    }
    .team-logo {
        width: 44px;
        height: 44px;
        object-fit: contain;
        border-radius: 6px;
        background: var(--bg-color);
    }
    .team-logo-placeholder {
        width: 44px;
        height: 44px;
        border-radius: 6px;
        background: var(--bg-color);
        display: flex;
        align-items: center;
        justify-content: center;
        color: var(--text-secondary);
        font-size: 0.9rem;
        font-weight: 600;
    }
    .team-name {
        font-weight: 600;
        font-size: 1.15rem;
    }
    /* TBD team styling */
    .team-logo-placeholder.tbd-team {
        background: var(--warning-color);
        color: white;
    }
    .team-logo-placeholder.tbd-team .material-icons {
        font-size: 1.5rem;
    }
    .team-name.tbd-team {
        color: var(--warning-color);
        font-style: italic;
    }
    /* Missing data warnings */
    .missing-data {
        color: var(--danger-color) !important;
        font-weight: 600;
        font-size: 0.85rem;
    }
    .team-logo-placeholder.missing-data {
        background: var(--danger-color);
        color: white;
    }
    .team-logo-placeholder.missing-data .material-icons {
        font-size: 1.5rem;
    }
    .team-name.missing-data {
        font-size: 0.95rem;
    }
    /* Incomplete status styling */
    .match-card.status-incomplete {
        border-left-color: var(--warning-color);
        background: linear-gradient(to right, rgba(245, 158, 11, 0.08), transparent);
    }
    .vs-separator {
        color: var(--text-secondary);
        font-size: 1.1rem;
        padding: 0 0.5rem;
        font-weight: 600;
    }
    .match-card-meta {
        display: flex;
        align-items: center;
        gap: 1.25rem;
        flex-shrink: 0;
    }
    .match-datetime {
        display: flex;
        align-items: center;
        gap: 0.75rem;
        font-size: 1.1rem;
        white-space: nowrap;
    }
    .match-date {
        color: var(--text-secondary);
        font-size: 1.1rem;
    }
    .match-time {
        font-weight: 700;
        color: var(--text-primary);
        font-size: 1.25rem;
    }
    .match-competition {
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }
    .competition-badge {
        padding: 0.25rem 0.6rem;
        border-radius: 6px;
        font-size: 0.8rem;
        font-weight: 600;
        color: white;
        white-space: nowrap;
    }
    .match-venue {
        font-size: 1rem;
        color: var(--text-primary);
        display: flex;
        align-items: center;
        gap: 0.35rem;
        font-weight: 500;
    }
    .match-venue .material-icons {
        font-size: 1.1rem;
        color: var(--accent-color);
    }

    .match-card-footer {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding-top: 1rem;
        border-top: 1px solid var(--border-color);
        margin-top: 0.75rem;
    }
    .match-card-status-row {
        display: flex;
        align-items: center;
        gap: 0.75rem;
    }
    .match-referees-row {
        display: flex;
        flex-wrap: wrap;
        gap: 0.75rem 2.5rem;
        font-size: 1rem;
    }
    .referee-item {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        padding: 0.25rem 0;
    }
    .referee-role {
        color: var(--text-secondary);
        font-weight: 500;
        min-width: 90px;
    }
    .referee-name {
        color: var(--text-primary);
        font-weight: 600;
    }
    .referee-name a {
        color: var(--accent-color);
        text-decoration: none;
    }
    .referee-name a:hover {
        text-decoration: underline;
    }
    .match-status-badge {
        display: flex;
        align-items: center;
        gap: 0.35rem;
        font-size: 0.8rem;
        padding: 0.25rem 0.6rem;
        border-radius: 20px;
        font-weight: 500;
    }
    .match-status-badge.draft {
        background: rgba(128, 128, 128, 0.15);
        color: var(--text-secondary);
    }
    .match-status-badge.scheduled {
        background: rgba(255, 193, 7, 0.15);
        color: #b38600;
    }
    .match-status-badge.confirmed {
        background: rgba(40, 167, 69, 0.15);
        color: var(--success-color);
    }
    .match-status-badge.cancelled {
        background: rgba(220, 53, 69, 0.15);
        color: var(--danger-color);
    }
    .match-status-badge.created {
        background: rgba(99, 102, 241, 0.15);
        color: var(--accent-color);
    }
    .match-status-badge.incomplete,
    .match-status-badge.incomplete {
        background: rgba(245, 158, 11, 0.25);
        color: #b38600;
    }
    .match-status-badge.postponed {
        background: rgba(156, 163, 175, 0.2);
        color: var(--text-secondary);
    }
    .confirmation-count {
        display: flex;
        align-items: center;
        gap: 0.25rem;
        font-size: 0.85rem;
        color: var(--text-secondary);
    }
    .confirmation-count .material-icons {
        font-size: 1rem;
    }
    .confirmation-count.has-declined {
        color: #dc2626;
        font-weight: 600;
    }

    .empty-state {
        text-align: center;
        padding: 3rem;
        color: var(--text-secondary);
    }
    .empty-state .material-icons {
        font-size: 3rem;
        opacity: 0.5;
        margin-bottom: 1rem;
    }

    /* Match card action icons */
    .match-card-actions {
        display: flex;
        gap: 0.25rem;
        margin-left: 1rem;
    }
    .match-action-btn {
        background: none;
        border: none;
        padding: 0.35rem;
        border-radius: 6px;
        cursor: pointer;
        color: var(--text-secondary);
        transition: all 0.15s;
        display: flex;
        align-items: center;
        justify-content: center;
    }
    .match-action-btn:hover {
        background: var(--bg-color);
        color: var(--text-primary);
    }
    .match-action-btn.active {
        color: var(--accent-color);
    }
    .match-action-btn.danger:hover {
        background: rgba(220, 53, 69, 0.1);
        color: var(--danger-color);
    }
    .match-action-btn .material-icons {
        font-size: 1.25rem;
    }

    /* Hidden match card style */
    .match-card.is-hidden {
        opacity: 0.6;
        background: repeating-linear-gradient(
            45deg,
            var(--card-bg),
            var(--card-bg) 10px,
            var(--bg-color) 10px,
            var(--bg-color) 20px
        );
    }

    /* Unpublished assignment style */
    .match-card.assignment-unpublished .match-referees-row {
        opacity: 0.5;
    }
    .unpublished-notice {
        color: var(--text-secondary);
        font-style: italic;
        font-size: 0.9rem;
        display: flex;
        align-items: center;
        gap: 0.35rem;
    }
    .unpublished-notice .material-icons {
        font-size: 1rem;
    }

    /* Create match form in sidebar */
    .create-match-form .form-group {
        margin-bottom: 1rem;
    }
    .create-match-form .form-row {
        display: flex;
        gap: 0.75rem;
    }
    .create-match-form .form-row .form-group {
        flex: 1;
    }
    .create-match-form input,
    .create-match-form select {
        width: 100%;
        padding: 0.5rem 0.75rem;
        border: 1px solid var(--border-color);
        border-radius: 6px;
        font-size: 0.9rem;
        background: var(--card-bg);
        color: var(--text-primary);
    }
    .create-match-form input:focus,
    .create-match-form select:focus {
        outline: none;
        border-color: var(--accent-color);
    }

    /* Filter styles */
    .filter-form {
        display: flex;
        flex-wrap: wrap;
        gap: 1rem;
        margin-bottom: 1rem;
        padding: 1rem;
        background: var(--card-bg);
        border: 1px solid var(--border-color);
        border-radius: 8px;
        align-items: flex-end;
    }
    .filter-group {
        display: flex;
        flex-direction: column;
        gap: 0.25rem;
    }
    .filter-group label {
        font-size: 0.85rem;
        color: var(--text-secondary);
    }
    .filter-group select,
    .filter-group input {
        padding: 0.5rem 0.75rem;
        border: 1px solid var(--border-color);
        border-radius: 6px;
        background: var(--bg-color);
        color: var(--text-primary);
        min-width: 150px;
    }
    .filter-group select:focus,
    .filter-group input:focus {
        outline: none;
        border-color: var(--accent-color);
    }
    .filter-buttons {
        display: flex;
        align-items: flex-end;
        gap: 0.5rem;
    }

    /* Pagination styles */
    .pagination-container {
        display: flex;
        justify-content: center;
        align-items: center;
        padding: 1.5rem 0;
        gap: 0.5rem;
    }
    .pagination-btn {
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 0.5rem 0.75rem;
        border: 1px solid var(--border-color);
        border-radius: 6px;
        background: var(--card-bg);
        color: var(--text-primary);
        text-decoration: none;
        font-size: 0.9rem;
        transition: all 0.15s;
        min-width: 36px;
    }
    .pagination-btn:hover:not(.disabled):not(.active) {
        border-color: var(--accent-color);
        color: var(--accent-color);
    }
    .pagination-btn.active {
        background: var(--accent-color);
        color: white;
        border-color: var(--accent-color);
    }
    .pagination-btn.disabled {
        opacity: 0.5;
        cursor: not-allowed;
    }
    .pagination-info {
        color: var(--text-secondary);
        font-size: 0.85rem;
        margin: 0 1rem;
    }

    /* Mobile Responsive */
    @media (max-width: 1024px) {
        .page-layout {
            flex-direction: column;
            height: auto;
            margin: 0;
        }
        .matches-list-panel {
            padding: 1rem;
            min-height: auto;
        }
        .sidebar-panel {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            width: 100%;
            z-index: 1000;
            border-left: none;
        }
        .sidebar-panel.open {
            display: flex;
        }
    }

    @media (max-width: 768px) {
        /* Filter form mobile */
        .filter-form {
            flex-direction: column;
            gap: 0.75rem;
        }
        .filter-group {
            width: 100%;
        }
        .filter-group select,
        .filter-group input {
            width: 100%;
            min-width: unset;
        }
        .filter-buttons {
            width: 100%;
            justify-content: stretch;
        }
        .filter-buttons .btn {
            flex: 1;
        }

        /* Card header mobile */
        .card-header {
            flex-direction: column;
            gap: 1rem;
            align-items: stretch;
        }
        .card-header > div {
            display: flex;
            gap: 0.5rem;
        }
        .card-header > div .btn {
            flex: 1;
            justify-content: center;
            font-size: 0.85rem;
            padding: 0.6rem 0.75rem;
        }

        /* Match card mobile */
        .match-card {
            padding: 0.75rem 1rem;
        }
        .match-card-header {
            flex-direction: column;
            align-items: stretch;
            gap: 0.75rem;
            margin-bottom: 0.75rem;
        }
        .match-card-teams {
            flex-wrap: wrap;
            gap: 0.35rem;
        }
        .team-info {
            gap: 0.35rem;
        }
        .team-logo, .team-logo-placeholder {
            width: 32px;
            height: 32px;
            font-size: 0.65rem;
        }
        .team-name {
            font-size: 0.95rem;
        }
        .vs-separator {
            padding: 0 0.25rem;
            font-size: 0.9rem;
        }
        .match-card-meta {
            flex-wrap: wrap;
            gap: 0.5rem 0.75rem;
        }
        .match-datetime {
            font-size: 0.9rem;
            gap: 0.35rem;
        }
        .match-date {
            font-size: 0.9rem;
        }
        .match-time {
            font-size: 1rem;
        }
        .match-venue {
            font-size: 0.85rem;
            max-width: 100%;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        .competition-badge {
            font-size: 0.7rem;
            padding: 0.2rem 0.4rem;
        }

        /* Match card footer mobile */
        .match-card-footer {
            flex-direction: column;
            align-items: stretch;
            gap: 0.75rem;
            padding-top: 0.75rem;
        }
        .match-card-status-row {
            flex-wrap: wrap;
            gap: 0.5rem;
            justify-content: flex-end;
        }
        .match-referees-row {
            gap: 0.35rem 1rem;
        }
        .referee-item {
            font-size: 0.85rem;
        }
        .referee-role {
            min-width: 70px;
            font-size: 0.8rem;
        }
        .match-status-badge {
            align-self: flex-start;
        }
        /* Confirmation count - keep on one line */
        .confirmation-count {
            white-space: nowrap;
            flex-shrink: 0;
        }
        /* Action buttons - prevent overflow */
        .match-card-actions {
            margin-left: 0.5rem;
            gap: 0.15rem;
        }
        .match-action-btn {
            padding: 0.25rem;
        }
        .match-action-btn .material-icons {
            font-size: 1.1rem;
        }
        .assignment-action-btns {
            flex-direction: column;
            gap: 0.5rem;
            width: 100%;
        }
        .assignment-action-btns .btn {
            width: 100%;
            justify-content: center;
        }

        /* Sidebar mobile */
        .sidebar-header {
            padding: 0.75rem 1rem;
        }
        .sidebar-title {
            font-size: 1rem;
        }
        .sidebar-content {
            padding: 1rem;
        }
        .sidebar-actions {
            flex-wrap: wrap;
            gap: 0.35rem;
        }
        .sidebar-actions .btn-sm {
            flex: 1;
            min-width: calc(50% - 0.35rem);
            justify-content: center;
        }
        .match-summary {
            padding: 0.75rem;
        }
        .match-summary-teams {
            font-size: 0.9rem;
        }
        .match-summary-meta {
            font-size: 0.8rem;
        }

        /* Tabs mobile */
        .tabs-wrapper {
            flex-wrap: wrap;
        }
        .tab-btn {
            flex: 1;
            min-width: calc(50% - 0.25rem);
            justify-content: center;
            padding: 0.5rem 0.75rem;
            font-size: 0.8rem;
        }

        /* Pagination mobile */
        .pagination-container {
            flex-wrap: wrap;
            gap: 0.35rem;
            padding: 1rem 0;
        }
        .pagination-btn {
            padding: 0.4rem 0.6rem;
            min-width: 32px;
        }
        .pagination-info {
            width: 100%;
            text-align: center;
            order: -1;
            margin: 0 0 0.5rem 0;
        }

        /* Toast mobile */
        .toast-notification {
            left: 1rem;
            right: 1rem;
            transform: translateX(0) translateY(100px);
            width: auto;
        }
        .toast-notification.show {
            transform: translateX(0) translateY(0);
        }
    }

    @media (max-width: 480px) {
        .match-card-teams {
            flex-direction: column;
            align-items: flex-start;
        }
        .vs-separator {
            display: none;
        }
        .team-info:not(:first-child)::before {
            content: 'vs ';
            color: var(--text-secondary);
            font-size: 0.75rem;
            margin-right: 0.25rem;
        }
        .match-datetime {
            width: 100%;
            justify-content: space-between;
        }
        .referee-role {
            display: none;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="page-layout">
    <!-- Matches List Panel -->
    <div class="matches-list-panel">
        <div class="card-header">
            <h3 class="card-title" style="margin: 0;">Mérkőzések</h3>
            <div style="display: flex; gap: 0.5rem;">
                <button type="button" class="btn btn-primary" onclick="openNewMatchSidebar(false)">
                    <span class="material-icons">add</span>
                    Új mérkőzés
                </button>
                <button type="button" class="btn btn-secondary" onclick="openNewMatchSidebar(true)">
                    <span class="material-icons">emoji_events</span>
                    Új torna
                </button>
            </div>
        </div>

        <!-- Tabs for upcoming/past matches -->
        <div class="tabs-container" style="padding: 0 1rem; margin-bottom: 1rem;">
            <div class="tabs" style="display: flex; gap: 0.5rem;">
                <a href="?tab=upcoming" class="tab-btn {% if current_tab == 'upcoming' %}active{% endif %}">
                    <span class="material-icons">event_available</span>
                    Közelgő
                </a>
                <a href="?tab=past" class="tab-btn {% if current_tab == 'past' %}active{% endif %}">
                    <span class="material-icons">history</span>
                    Múltbéli
                </a>
            </div>
        </div>

        <!-- Filters -->
        <form method="get" class="filter-form">
            <input type="hidden" name="tab" value="{{ current_tab }}">
            <div class="filter-group">
                <label>Csapat</label>
                <select name="team">
                    <option value="">Összes csapat</option>
                    {% for team in teams %}
                    {% if not team.is_tbd %}
                    <option value="{{ team.id }}" {% if filter_team == team.id|stringformat:"s" %}selected{% endif %}>{{ team.name }}</option>
                    {% endif %}
                    {% endfor %}
                </select>
            </div>
            <div class="filter-group">
                <label>Helyszín</label>
                <select name="venue">
                    <option value="">Összes helyszín</option>
                    {% for venue in venues %}
                    <option value="{{ venue.id }}" {% if filter_venue == venue.id|stringformat:"s" %}selected{% endif %}>{{ venue.name }}</option>
                    {% endfor %}
                </select>
            </div>
            <div class="filter-group">
                <label>Bajnokság</label>
                <select name="competition">
                    <option value="">Összes bajnokság</option>
                    {% for comp in competitions %}
                    <option value="{{ comp.id }}" {% if filter_competition == comp.id|stringformat:"s" %}selected{% endif %}>{{ comp.name }}</option>
                    {% endfor %}
                </select>
            </div>
            <div class="filter-group">
                <label>Dátumtól</label>
                <input type="date" name="date_from" value="{{ filter_date_from }}">
            </div>
            <div class="filter-group">
                <label>Dátumig</label>
                <input type="date" name="date_to" value="{{ filter_date_to }}">
            </div>
            <div class="filter-buttons">
                <button type="submit" class="btn btn-primary">
                    <span class="material-icons">search</span>
                    Szűrés
                </button>
                <a href="?tab={{ current_tab }}" class="btn btn-secondary">
                    <span class="material-icons">clear</span>
                    Törlés
                </a>
            </div>
        </form>

        {% if page_obj.paginator.count > 0 %}
        <div style="margin-bottom: 1rem; color: var(--text-secondary); font-size: 0.9rem;">
            {{ page_obj.paginator.count }} mérkőzés találat
        </div>
        {% endif %}

        {% if matches %}
        {% for match in matches %}
        <div class="match-card status-{{ match.status }}{% if match.is_hidden %} is-hidden{% endif %}{% if not match.is_assignment_published %} assignment-unpublished{% endif %}" data-match-id="{{ match.id }}" data-is-hidden="{{ match.is_hidden|yesno:'true,false' }}" data-is-assignment-published="{{ match.is_assignment_published|yesno:'true,false' }}" onclick="openAssignmentSidebar({{ match.id }})">
            <div class="match-card-header">
                <div class="match-card-teams">
                    {% if match.is_tournament %}
                    <!-- Torna: rendező csapat + Torna badge -->
                    <div class="team-info">
                        {% if match.home_team %}
                        {% if match.home_team.logo %}
                        <img src="{{ match.home_team.logo.url }}" alt="" class="team-logo">
                        {% else %}
                        <div class="team-logo-placeholder">{{ match.home_team.short_name|default:match.home_team.name|slice:":2"|upper }}</div>
                        {% endif %}
                        <span class="team-name">{{ match.home_team.name }}</span>
                        {% else %}
                        <div class="team-logo-placeholder missing-data"><span class="material-icons">error_outline</span></div>
                        <span class="team-name missing-data">NINCS CSAPAT!</span>
                        {% endif %}
                    </div>
                    <div class="team-info" style="justify-content: center;">
                        <span style="background: #7c3aed; color: white; padding: 0.25rem 0.6rem; border-radius: 12px; font-size: 0.75rem; font-weight: 600; display: flex; align-items: center; gap: 0.25rem;">
                            <span class="material-icons" style="font-size: 0.9rem;">emoji_events</span>
                            Torna
                        </span>
                        <span style="font-size: 0.7rem; color: var(--text-secondary); margin-left: 0.5rem;">
                            {{ match.tournament_match_count }} meccs / {{ match.tournament_court_count }} pálya
                        </span>
                    </div>
                    {% else %}
                    <!-- Normal meccs: hazai vs vendég -->
                    <div class="team-info">
                        {% if match.home_team.is_tbd %}
                        <div class="team-logo-placeholder tbd-team"><span class="material-icons">help_outline</span></div>
                        <span class="team-name tbd-team">TBD</span>
                        {% elif match.home_team %}
                        {% if match.home_team.logo %}
                        <img src="{{ match.home_team.logo.url }}" alt="" class="team-logo">
                        {% else %}
                        <div class="team-logo-placeholder">{{ match.home_team.short_name|default:match.home_team.name|slice:":2"|upper }}</div>
                        {% endif %}
                        <span class="team-name">{{ match.home_team.name }}</span>
                        {% else %}
                        <div class="team-logo-placeholder missing-data"><span class="material-icons">error_outline</span></div>
                        <span class="team-name missing-data">NINCS CSAPAT!</span>
                        {% endif %}
                    </div>
                    <span class="vs-separator">-</span>
                    <div class="team-info">
                        {% if match.away_team.is_tbd %}
                        <div class="team-logo-placeholder tbd-team"><span class="material-icons">help_outline</span></div>
                        <span class="team-name tbd-team">TBD</span>
                        {% elif match.away_team %}
                        {% if match.away_team.logo %}
                        <img src="{{ match.away_team.logo.url }}" alt="" class="team-logo">
                        {% else %}
                        <div class="team-logo-placeholder">{{ match.away_team.short_name|default:match.away_team.name|slice:":2"|upper }}</div>
                        {% endif %}
                        <span class="team-name">{{ match.away_team.name }}</span>
                        {% else %}
                        <div class="team-logo-placeholder missing-data"><span class="material-icons">error_outline</span></div>
                        <span class="team-name missing-data">NINCS CSAPAT!</span>
                        {% endif %}
                    </div>
                    {% endif %}
                </div>
                <div class="match-card-meta">
                    {% if match.phase %}
                    <div class="match-competition">
                        <span class="competition-badge" style="background: {{ match.phase.competition.color }};">
                            {{ match.phase.competition.short_name }}
                        </span>
                        <span style="font-size: 0.8rem; color: var(--text-secondary);">{{ match.phase.name }}</span>
                    </div>
                    {% endif %}
                    <div class="match-datetime">
                        {% if match.date %}
                        <span class="match-date">{{ match.date|date:"Y.m.d" }} ({{ match.date|date:"D" }})</span>
                        {% else %}
                        <span class="match-date missing-data">NINCS DÁTUM!</span>
                        {% endif %}
                        {% if match.has_time %}
                        <span class="match-time">{{ match.time|time:"H:i" }}</span>
                        {% else %}
                        <span class="match-time missing-data">NINCS IDŐPONT!</span>
                        {% endif %}
                    </div>
                    <div class="match-venue">
                        <span class="material-icons">location_on</span>
                        {% if match.venue %}
                        {{ match.venue.name }}{% if match.court %} ({{ match.court }}){% endif %}
                        {% else %}
                        <span class="missing-data">NINCS HELYSZÍN!</span>
                        {% endif %}
                    </div>
                </div>
            </div>
            <div class="match-card-footer">
                <div class="match-referees-row" data-match-id="{{ match.id }}">
                    {% with referees=match.get_referees reserves=match.get_reserves inspectors=match.get_inspectors tournament_directors=match.get_tournament_directors %}
                    {% for assignment in referees %}
                    <div class="referee-item">
                        {% if assignment.placeholder_type %}
                        <span class="referee-role">Játékvezető</span>
                        <span class="referee-name" style="{% if assignment.placeholder_type == 'hianyzik' %}color: var(--danger-color); font-weight: 600;{% elif assignment.placeholder_type == 'szukseges' %}color: var(--warning-color); font-weight: 600;{% else %}color: var(--text-secondary);{% endif %}">
                            {% if assignment.placeholder_type == 'hianyzik' %}Hiányzik!{% elif assignment.placeholder_type == 'szukseges' %}Szükséges{% else %}Nincs{% endif %}
                        </span>
                        {% else %}
                        <span class="material-icons response-status-icon {% if match.status == 'draft' and assignment.response_status == 'pending' %}response-draft{% else %}response-{{ assignment.response_status }}{% endif %}">
                            {% if assignment.response_status == 'accepted' %}check_circle{% elif assignment.response_status == 'declined' %}cancel{% elif match.status == 'draft' %}edit{% else %}schedule{% endif %}
                        </span>
                        <span class="referee-role">Játékvezető</span>
                        <span class="referee-name">{{ assignment.user.get_full_name }}</span>
                        {% endif %}
                    </div>
                    {% empty %}
                    <div class="referee-item" style="color: var(--text-secondary);">
                        <span class="material-icons" style="font-size: 1rem;">person_off</span>
                        <span>Nincs játékvezető kijelölve</span>
                    </div>
                    {% endfor %}
                    {% for assignment in reserves %}
                    <div class="referee-item">
                        {% if assignment.placeholder_type %}
                        <span class="referee-role">Tartalék</span>
                        <span class="referee-name" style="{% if assignment.placeholder_type == 'hianyzik' %}color: var(--danger-color); font-weight: 600;{% elif assignment.placeholder_type == 'szukseges' %}color: var(--warning-color); font-weight: 600;{% else %}color: var(--text-secondary);{% endif %}">
                            {% if assignment.placeholder_type == 'hianyzik' %}Hiányzik!{% elif assignment.placeholder_type == 'szukseges' %}Szükséges{% else %}Nincs{% endif %}
                        </span>
                        {% else %}
                        <span class="material-icons response-status-icon {% if match.status == 'draft' and assignment.response_status == 'pending' %}response-draft{% else %}response-{{ assignment.response_status }}{% endif %}">
                            {% if assignment.response_status == 'accepted' %}check_circle{% elif assignment.response_status == 'declined' %}cancel{% elif match.status == 'draft' %}edit{% else %}schedule{% endif %}
                        </span>
                        <span class="referee-role">Tartalék</span>
                        <span class="referee-name">{{ assignment.user.get_full_name }}</span>
                        {% endif %}
                    </div>
                    {% endfor %}
                    {% for assignment in inspectors %}
                    <div class="referee-item">
                        {% if assignment.placeholder_type %}
                        <span class="referee-role">Ellenőr</span>
                        <span class="referee-name" style="{% if assignment.placeholder_type == 'hianyzik' %}color: var(--danger-color); font-weight: 600;{% elif assignment.placeholder_type == 'szukseges' %}color: var(--warning-color); font-weight: 600;{% else %}color: var(--text-secondary);{% endif %}">
                            {% if assignment.placeholder_type == 'hianyzik' %}Hiányzik!{% elif assignment.placeholder_type == 'szukseges' %}Szükséges{% else %}Nincs{% endif %}
                        </span>
                        {% else %}
                        <span class="material-icons response-status-icon {% if match.status == 'draft' and assignment.response_status == 'pending' %}response-draft{% else %}response-{{ assignment.response_status }}{% endif %}">
                            {% if assignment.response_status == 'accepted' %}check_circle{% elif assignment.response_status == 'declined' %}cancel{% elif match.status == 'draft' %}edit{% else %}schedule{% endif %}
                        </span>
                        <span class="referee-role">Ellenőr</span>
                        <span class="referee-name">{{ assignment.user.get_full_name }}</span>
                        {% endif %}
                    </div>
                    {% endfor %}
                    {% for assignment in tournament_directors %}
                    <div class="referee-item">
                        {% if assignment.placeholder_type %}
                        <span class="referee-role">Tornaig.</span>
                        <span class="referee-name" style="{% if assignment.placeholder_type == 'hianyzik' %}color: var(--danger-color); font-weight: 600;{% elif assignment.placeholder_type == 'szukseges' %}color: var(--warning-color); font-weight: 600;{% else %}color: var(--text-secondary);{% endif %}">
                            {% if assignment.placeholder_type == 'hianyzik' %}Hiányzik!{% elif assignment.placeholder_type == 'szukseges' %}Szükséges{% else %}Nincs{% endif %}
                        </span>
                        {% else %}
                        <span class="material-icons response-status-icon {% if match.status == 'draft' and assignment.response_status == 'pending' %}response-draft{% else %}response-{{ assignment.response_status }}{% endif %}">
                            {% if assignment.response_status == 'accepted' %}check_circle{% elif assignment.response_status == 'declined' %}cancel{% elif match.status == 'draft' %}edit{% else %}schedule{% endif %}
                        </span>
                        <span class="referee-role">Tornaig.</span>
                        <span class="referee-name">{{ assignment.user.get_full_name }}</span>
                        {% endif %}
                    </div>
                    {% endfor %}
                    {% endwith %}
                </div>
                <div class="match-card-status-row">
                    {% if match.status == 'draft' %}
                    <div class="confirmation-count" title="Piszkozat - csak ezen az oldalon látható" style="color: var(--text-secondary);">
                        <span class="material-icons" style="font-size: 1.2rem;">edit</span>
                    </div>
                    {% elif match.actual_referee_count > 0 and match.is_assignment_published %}
                    <div class="confirmation-count{% if match.has_declined %} has-declined{% endif %}" title="Visszaigazolások">
                        <span>{{ match.confirmed_count }}&nbsp;/&nbsp;{{ match.actual_referee_count }}</span>
                        {% if match.has_declined %}
                        <span class="material-icons" style="color: #dc2626;">cancel</span>
                        {% elif match.is_all_confirmed %}
                        <span class="material-icons" style="color: #16a34a;">check_circle</span>
                        {% else %}
                        <span class="material-icons" style="color: #ca8a04;">pending</span>
                        {% endif %}
                    </div>
                    {% elif match.is_assignment_published and match.actual_referee_count == 0 %}
                    <div class="confirmation-count" title="Nincs játékvezető kiírva" style="color: #dc2626;">
                        <span>0&nbsp;/&nbsp;0</span>
                        <span class="material-icons">error</span>
                    </div>
                    {% endif %}
                    <span class="match-status-badge {{ match.status }}{% if match.is_incomplete and match.status != 'cancelled' %} incomplete{% endif %}">
                        {% if match.status == 'cancelled' %}
                        <span class="material-icons">cancel</span> Elmarad
                        {% elif match.is_incomplete %}
                        <span class="material-icons">warning</span> Hiányos
                        {% elif match.status == 'created' %}
                        <span class="material-icons">fiber_new</span> Létrehozott
                        {% elif match.status == 'draft' %}
                        <span class="material-icons">edit</span> Piszkozat
                        {% elif match.status == 'scheduled' %}
                        <span class="material-icons">schedule</span> Kiírva
                        {% elif match.status == 'confirmed' %}
                        <span class="material-icons">check_circle</span> Visszaigazolva
                        {% elif match.status == 'postponed' %}
                        <span class="material-icons">event_busy</span> Halasztott
                        {% endif %}
                    </span>
                    <div class="match-card-actions" onclick="event.stopPropagation();">
                        <button type="button" class="match-action-btn toggle-cancelled-btn{% if match.status == 'cancelled' %} active{% endif %}" onclick="toggleMatchCancelled({{ match.id }})" title="Elmarad">
                            <span class="material-icons">{% if match.status == 'cancelled' %}flag{% else %}outlined_flag{% endif %}</span>
                        </button>
                        <button type="button" class="match-action-btn toggle-assignment-btn{% if not match.is_assignment_published %} active{% endif %}" onclick="toggleAssignmentPublished({{ match.id }})" title="Kiírás publikálása/elrejtése">
                            <span class="material-icons">{% if match.is_assignment_published %}person{% else %}person_off{% endif %}</span>
                        </button>
                        <button type="button" class="match-action-btn toggle-hidden-btn{% if match.is_hidden %} active{% endif %}" onclick="toggleMatchHidden({{ match.id }})" title="Mérkőzés elrejtése">
                            <span class="material-icons">{% if match.is_hidden %}visibility_off{% else %}visibility{% endif %}</span>
                        </button>
                        <button type="button" class="match-action-btn" onclick="openMatchDataSidebar({{ match.id }})" title="Adatok szerkesztése">
                            <span class="material-icons">edit</span>
                        </button>
                        <button type="button" class="match-action-btn danger" onclick="deleteMatchDirect({{ match.id }})" title="Törlés">
                            <span class="material-icons">delete</span>
                        </button>
                    </div>
                </div>
            </div>
        </div>
        {% endfor %}

        <!-- Pagination -->
        {% if page_obj.has_other_pages %}
        <div class="pagination-container">
            {% if page_obj.has_previous %}
            <a href="?tab={{ current_tab }}&page=1{% if filter_team %}&team={{ filter_team }}{% endif %}{% if filter_venue %}&venue={{ filter_venue }}{% endif %}{% if filter_competition %}&competition={{ filter_competition }}{% endif %}{% if filter_date_from %}&date_from={{ filter_date_from }}{% endif %}{% if filter_date_to %}&date_to={{ filter_date_to }}{% endif %}" class="pagination-btn" title="Első oldal">
                <span class="material-icons">first_page</span>
            </a>
            <a href="?tab={{ current_tab }}&page={{ page_obj.previous_page_number }}{% if filter_team %}&team={{ filter_team }}{% endif %}{% if filter_venue %}&venue={{ filter_venue }}{% endif %}{% if filter_competition %}&competition={{ filter_competition }}{% endif %}{% if filter_date_from %}&date_from={{ filter_date_from }}{% endif %}{% if filter_date_to %}&date_to={{ filter_date_to }}{% endif %}" class="pagination-btn" title="Előző">
                <span class="material-icons">chevron_left</span>
            </a>
            {% else %}
            <span class="pagination-btn disabled"><span class="material-icons">first_page</span></span>
            <span class="pagination-btn disabled"><span class="material-icons">chevron_left</span></span>
            {% endif %}

            <span class="pagination-info">
                {{ page_obj.number }} / {{ page_obj.paginator.num_pages }} oldal
            </span>

            {% if page_obj.has_next %}
            <a href="?tab={{ current_tab }}&page={{ page_obj.next_page_number }}{% if filter_team %}&team={{ filter_team }}{% endif %}{% if filter_venue %}&venue={{ filter_venue }}{% endif %}{% if filter_competition %}&competition={{ filter_competition }}{% endif %}{% if filter_date_from %}&date_from={{ filter_date_from }}{% endif %}{% if filter_date_to %}&date_to={{ filter_date_to }}{% endif %}" class="pagination-btn" title="Következő">
                <span class="material-icons">chevron_right</span>
            </a>
            <a href="?tab={{ current_tab }}&page={{ page_obj.paginator.num_pages }}{% if filter_team %}&team={{ filter_team }}{% endif %}{% if filter_venue %}&venue={{ filter_venue }}{% endif %}{% if filter_competition %}&competition={{ filter_competition }}{% endif %}{% if filter_date_from %}&date_from={{ filter_date_from }}{% endif %}{% if filter_date_to %}&date_to={{ filter_date_to }}{% endif %}" class="pagination-btn" title="Utolsó oldal">
                <span class="material-icons">last_page</span>
            </a>
            {% else %}
            <span class="pagination-btn disabled"><span class="material-icons">chevron_right</span></span>
            <span class="pagination-btn disabled"><span class="material-icons">last_page</span></span>
            {% endif %}
        </div>
        {% endif %}

        {% else %}
        <div class="empty-state">
            <span class="material-icons">edit_calendar</span>
            <p>Nincs mérkőzés</p>
        </div>
        {% endif %}
    </div>

    <!-- New Match Sidebar -->
    <div class="sidebar-panel" id="newMatchSidebar">
        <div class="sidebar-header">
            <div class="sidebar-title">
                <span class="material-icons" id="newMatchSidebarIcon" style="color: var(--success-color);">add_circle</span>
                <span id="newMatchSidebarTitle">Új mérkőzés</span>
            </div>
            <button type="button" class="sidebar-close" onclick="closeNewMatchSidebar()">&times;</button>
        </div>
        <div class="sidebar-content">
            <div class="create-match-form">
                <input type="hidden" id="newMatchIsTournament" value="false">

                <div class="form-row">
                    <div class="form-group">
                        <label>Dátum *</label>
                        <input type="date" id="newMatchDate" required>
                    </div>
                    <div class="form-group">
                        <label>Időpont *</label>
                        <input type="time" id="newMatchTime" required>
                    </div>
                </div>

                <div class="form-group">
                    <label>Bajnokság / Szakasz</label>
                    <select id="newMatchPhase">
                        <option value="">-- Válassz --</option>
                        {% for phase in phases %}
                        <option value="{{ phase.id }}">{{ phase.competition.short_name }} - {{ phase.name }}</option>
                        {% endfor %}
                    </select>
                </div>

                <div id="newMatchTournamentFieldsGroup" style="display: none;">
                    <div class="form-row">
                        <div class="form-group">
                            <label>Meccsek száma *</label>
                            <input type="number" id="newMatchTournamentCount" min="1" value="1" placeholder="pl. 10">
                        </div>
                        <div class="form-group">
                            <label>Pályák száma *</label>
                            <input type="number" id="newMatchCourtCount" min="1" value="1" placeholder="pl. 2">
                        </div>
                    </div>
                    <small style="color: var(--text-secondary); display: block; margin-bottom: 1rem;">
                        Játékvezetők száma = pályák száma. Díjazás: összeg × meccsszám / pályák száma
                    </small>
                </div>

                <div class="form-group" id="newMatchHomeTeamGroup">
                    <label id="newMatchHomeTeamLabel">Hazai csapat</label>
                    <select id="newMatchHomeTeam">
                        <option value="">-- Válassz --</option>
                        {% for team in teams %}
                        <option value="{{ team.id }}">{{ team.name }}</option>
                        {% endfor %}
                    </select>
                </div>

                <div class="form-group" id="newMatchAwayTeamGroup">
                    <label>Vendég csapat</label>
                    <select id="newMatchAwayTeam">
                        <option value="">-- Válassz --</option>
                        {% for team in teams %}
                        <option value="{{ team.id }}">{{ team.name }}</option>
                        {% endfor %}
                    </select>
                </div>

                <div class="form-group">
                    <label>Helyszín</label>
                    <select id="newMatchVenue">
                        <option value="">-- Válassz --</option>
                        {% for venue in venues %}
                        <option value="{{ venue.id }}">{{ venue.name }} ({{ venue.city }})</option>
                        {% endfor %}
                    </select>
                </div>

                <div class="form-group">
                    <label>Pálya</label>
                    <input type="text" id="newMatchCourt" placeholder="pl. 1. pálya">
                </div>

                <div class="form-group">
                    <label>Megjegyzés</label>
                    <textarea id="newMatchNotes" rows="3" placeholder="Megjegyzés a mérkőzéshez..."></textarea>
                </div>
            </div>
        </div>
        <div class="sidebar-actions">
            <button type="button" class="btn btn-secondary" onclick="closeNewMatchSidebar()">
                <span class="material-icons">close</span>
                Mégse
            </button>
            <button type="button" class="btn btn-primary" onclick="createNewMatch()">
                <span class="material-icons">add</span>
                Létrehozás
            </button>
        </div>
    </div>

    <!-- Match Data Edit Sidebar -->
    <div class="sidebar-panel" id="matchDataSidebar">
        <div class="sidebar-header">
            <div class="sidebar-title">
                <span class="material-icons" style="color: var(--accent-color);">edit</span>
                <span>Mérkőzés adatok</span>
            </div>
            <button type="button" class="sidebar-close" onclick="closeMatchDataSidebar()">&times;</button>
        </div>
        <div class="sidebar-content">
            <div class="create-match-form">
                <div class="form-row">
                    <div class="form-group">
                        <label>Dátum</label>
                        <input type="date" id="editMatchDate">
                    </div>
                    <div class="form-group">
                        <label>Időpont</label>
                        <input type="time" id="editMatchTime">
                    </div>
                </div>

                <div class="form-group">
                    <label>Bajnokság / Szakasz</label>
                    <div class="custom-select-wrapper" id="editMatchPhaseWrapper">
                        <div class="custom-select" onclick="toggleMatchDataDropdown(this)" data-value="" data-field="phase">
                            <span class="custom-select-value placeholder">-- Válassz --</span>
                            <span class="material-icons custom-select-arrow">expand_more</span>
                        </div>
                        <div class="custom-select-dropdown">
                            <div class="custom-select-search">
                                <input type="text" placeholder="Keresés..." oninput="filterMatchDataOptions(this, 'phase')">
                            </div>
                            <div class="custom-select-options">
                                <div class="custom-select-option" data-value="" onclick="selectMatchDataOption(this, 'phase')">-- Nincs megadva --</div>
                                {% for phase in phases %}
                                <div class="custom-select-option" data-value="{{ phase.id }}" onclick="selectMatchDataOption(this, 'phase')">{{ phase.competition.short_name }} - {{ phase.name }}</div>
                                {% endfor %}
                            </div>
                        </div>
                    </div>
                </div>

                <div class="form-group" style="margin-top: 0.5rem;">
                    <label class="checkbox-label" style="display: inline-flex; align-items: center; gap: 0.5rem; cursor: pointer; justify-content: flex-start;">
                        <input type="checkbox" id="editMatchIsTournament" onchange="toggleEditMatchTournamentMode(this.checked)" style="width: auto;">
                        <span>Torna</span>
                    </label>
                </div>

                <div id="editMatchTournamentFieldsGroup" style="display: none;">
                    <div class="form-row">
                        <div class="form-group">
                            <label>Meccsek száma</label>
                            <input type="number" id="editMatchTournamentCount" min="1" value="1" placeholder="pl. 10" onchange="saveMatchField('tournament_match_count', this.value)">
                        </div>
                        <div class="form-group">
                            <label>Pályák száma</label>
                            <input type="number" id="editMatchCourtCount" min="1" value="1" placeholder="pl. 2" onchange="saveMatchField('tournament_court_count', this.value)">
                        </div>
                    </div>
                    <small style="color: var(--text-secondary); display: block; margin-bottom: 1rem;">
                        Játékvezetők száma = pályák száma
                    </small>
                </div>

                <div class="form-group">
                    <label>MFSZ bejelentés</label>
                    <select id="editMatchMfszOverride" onchange="saveMatchField('mfsz_declaration_override', this.value === '' ? null : this.value === 'true')">
                        <option value="">Szakasz beállítás szerint</option>
                        <option value="true">Kötelező bejelentés</option>
                        <option value="false">Nem kell bejelentés</option>
                    </select>
                    <small style="color: var(--text-secondary); display: block; margin-top: 0.25rem;">Felülírja a szakasz beállítását</small>
                </div>

                <div class="form-group" id="editMatchHomeTeamGroup">
                    <label id="editMatchHomeTeamLabel">Hazai csapat</label>
                    <div class="custom-select-wrapper" id="editMatchHomeTeamWrapper">
                        <div class="custom-select" onclick="toggleMatchDataDropdown(this)" data-value="" data-field="home_team">
                            <span class="custom-select-value placeholder">-- Válassz --</span>
                            <span class="material-icons custom-select-arrow">expand_more</span>
                        </div>
                        <div class="custom-select-dropdown">
                            <div class="custom-select-search">
                                <input type="text" placeholder="Keresés..." oninput="filterMatchDataOptions(this, 'home_team')">
                            </div>
                            <div class="custom-select-options">
                                <div class="custom-select-option" data-value="" onclick="selectMatchDataOption(this, 'home_team')">-- Nincs megadva --</div>
                                {% for team in teams %}
                                <div class="custom-select-option{% if team.is_tbd %} tbd-option{% endif %}" data-value="{{ team.id }}" data-is-tbd="{{ team.is_tbd|yesno:'true,false' }}" onclick="selectMatchDataOption(this, 'home_team')">
                                    {% if team.is_tbd %}<span class="material-icons" style="font-size: 1rem; vertical-align: middle; margin-right: 0.25rem;">help_outline</span>{% endif %}{{ team.name }}
                                </div>
                                {% endfor %}
                            </div>
                        </div>
                    </div>
                </div>

                <div class="form-group" id="editMatchAwayTeamGroup">
                    <label>Vendég csapat</label>
                    <div class="custom-select-wrapper" id="editMatchAwayTeamWrapper">
                        <div class="custom-select" onclick="toggleMatchDataDropdown(this)" data-value="" data-field="away_team">
                            <span class="custom-select-value placeholder">-- Válassz --</span>
                            <span class="material-icons custom-select-arrow">expand_more</span>
                        </div>
                        <div class="custom-select-dropdown">
                            <div class="custom-select-search">
                                <input type="text" placeholder="Keresés..." oninput="filterMatchDataOptions(this, 'away_team')">
                            </div>
                            <div class="custom-select-options">
                                <div class="custom-select-option" data-value="" onclick="selectMatchDataOption(this, 'away_team')">-- Nincs megadva --</div>
                                {% for team in teams %}
                                <div class="custom-select-option{% if team.is_tbd %} tbd-option{% endif %}" data-value="{{ team.id }}" data-is-tbd="{{ team.is_tbd|yesno:'true,false' }}" onclick="selectMatchDataOption(this, 'away_team')">
                                    {% if team.is_tbd %}<span class="material-icons" style="font-size: 1rem; vertical-align: middle; margin-right: 0.25rem;">help_outline</span>{% endif %}{{ team.name }}
                                </div>
                                {% endfor %}
                            </div>
                        </div>
                    </div>
                </div>

                <div class="form-group">
                    <label>Helyszín</label>
                    <div class="custom-select-wrapper" id="editMatchVenueWrapper">
                        <div class="custom-select" onclick="toggleMatchDataDropdown(this)" data-value="" data-field="venue">
                            <span class="custom-select-value placeholder">-- Válassz --</span>
                            <span class="material-icons custom-select-arrow">expand_more</span>
                        </div>
                        <div class="custom-select-dropdown">
                            <div class="custom-select-search">
                                <input type="text" placeholder="Keresés..." oninput="filterMatchDataOptions(this, 'venue')">
                            </div>
                            <div class="custom-select-options">
                                <div class="custom-select-option" data-value="" onclick="selectMatchDataOption(this, 'venue')">-- Nincs megadva --</div>
                                {% for venue in venues %}
                                <div class="custom-select-option" data-value="{{ venue.id }}" onclick="selectMatchDataOption(this, 'venue')">{{ venue.name }} ({{ venue.city }})</div>
                                {% endfor %}
                            </div>
                        </div>
                    </div>
                </div>

                <div class="form-group">
                    <label>Pálya</label>
                    <input type="text" id="editMatchCourt" placeholder="pl. 1. pálya">
                </div>
            </div>
        </div>
        <div class="sidebar-actions">
            <button type="button" class="btn btn-secondary btn-sm" onclick="closeMatchDataSidebar()">
                <span class="material-icons">close</span>
                Mégse
            </button>
            <button type="button" class="btn btn-secondary btn-sm" onclick="saveMatchData(false)" title="Mentés e-mail nélkül">
                <span class="material-icons">save</span>
                Mentés
            </button>
            <button type="button" class="btn btn-sm" onclick="saveMatchData(true)" style="background: var(--success-color); color: white;" title="Mentés és e-mail küldés a kiírt játékvezetőknek">
                <span class="material-icons">email</span>
                Mentés + email
            </button>
        </div>
    </div>

    <!-- Assignment Edit Sidebar Panel -->
    <div class="sidebar-panel" id="sidebarPanel">
        <div class="sidebar-header">
            <div class="sidebar-title">
                <span class="material-icons" style="color: var(--warning-color);">assignment_ind</span>
                <span>Kiírás szerkesztése</span>
            </div>
            <button type="button" class="sidebar-close" onclick="closeSidebar()">&times;</button>
        </div>
        <div class="sidebar-content">
            <input type="hidden" id="currentMatchId">

            <!-- Match Summary (read-only) -->
            <div class="match-summary">
                <div class="match-summary-header">
                    <span id="sidebarCompBadge" class="badge" style="display: none; margin-right: 0.5rem;"></span>
                    <div class="match-summary-teams">
                        <span id="summaryHomeTeam">-</span>
                        <span style="color: var(--text-secondary);">vs</span>
                        <span id="summaryAwayTeam">-</span>
                    </div>
                </div>
                <div class="match-summary-meta">
                    <span><span class="material-icons">event</span> <span id="summaryDate">-</span></span>
                    <span><span class="material-icons">schedule</span> <span id="summaryTime">-</span></span>
                    <span><span class="material-icons">location_on</span> <span id="summaryVenue">-</span></span>
                </div>
            </div>

            <div class="section-label">Játékvezetők</div>
            <div id="refereesContainer">
                <!-- Referees will be loaded here -->
            </div>

            <div class="section-label">Tartalék</div>
            <div id="reservesContainer">
                <!-- Reserves will be loaded here -->
            </div>

            <div class="section-label">Ellenőr</div>
            <div id="inspectorsContainer">
                <!-- Inspectors will be loaded here -->
            </div>

            <div class="section-label">Tornaigazgató</div>
            <div id="tournamentDirectorsContainer">
                <!-- Tournament Directors will be loaded here -->
            </div>

            <!-- Add section - grouped at bottom -->
            <div class="add-section">
                <div class="section-label" style="margin-top: 0;">Hozzáadás</div>
                <div class="add-buttons-grid">
                    <button type="button" class="add-btn-compact" onclick="addRefereeRow()">
                        <span class="material-icons">add</span> Játékvezető
                    </button>
                    <button type="button" class="add-btn-compact" onclick="addReserveRow()">
                        <span class="material-icons">add</span> Tartalék
                    </button>
                    <button type="button" class="add-btn-compact" onclick="addInspectorRow()">
                        <span class="material-icons">add</span> Ellenőr
                    </button>
                    <button type="button" class="add-btn-compact" onclick="addTournamentDirectorRow()">
                        <span class="material-icons">add</span> Tornaigazgató
                    </button>
                </div>
            </div>

            <div class="section-label">Megjegyzés</div>
            <div class="form-group" style="margin-bottom: 0;">
                <textarea id="matchNotes" rows="3" placeholder="Megjegyzés a mérkőzéshez..." onchange="saveMatchField('notes', this.value)"></textarea>
            </div>
        </div>
        <div class="sidebar-actions">
            <!-- Draft buttons (shown when status is draft) -->
            <button type="button" class="btn btn-secondary btn-sm" id="saveDraftBtn" onclick="saveDraft()" title="Piszkozat mentése">
                <span class="material-icons">save</span>
                Piszkozat
            </button>
            <button type="button" class="btn btn-primary btn-sm" id="publishBtn" onclick="publishMatch(false)" title="Kiírás e-mail nélkül">
                <span class="material-icons">send</span>
                Kiírás
            </button>
            <button type="button" class="btn btn-sm" id="publishEmailBtn" onclick="publishMatch(true)" style="background: var(--success-color); color: white;" title="Kiírás és e-mail küldés">
                <span class="material-icons">email</span>
                Kiírás + email
            </button>
            <!-- Edit buttons (shown when status is scheduled or confirmed) -->
            <button type="button" class="btn btn-secondary btn-sm" id="saveNoEmailBtn" onclick="saveChanges(false)" style="display: none;" title="Mentés e-mail nélkül">
                <span class="material-icons">save</span>
                Mentés
            </button>
            <button type="button" class="btn btn-sm" id="saveWithEmailBtn" onclick="saveChanges(true)" style="display: none; background: var(--success-color); color: white;" title="Mentés és e-mail küldés">
                <span class="material-icons">email</span>
                Mentés + email
            </button>
        </div>
    </div>
</div>

<!-- Hidden referees data for JS -->
<script>
const allReferees = [
    {% for ref in referees %}
    { id: {{ ref.id }}, name: "{{ ref.get_full_name|default:ref.username|escapejs }}" }{% if not forloop.last %},{% endif %}
    {% endfor %}
];

// Referee unavailabilities: user_id -> [{start, end}, ...]
const refereeUnavailabilities = {
    {% for user_id, periods in referee_unavailabilities.items %}
    {{ user_id }}: [{% for period in periods %}{start: "{{ period.start }}", end: "{{ period.end }}"}{% if not forloop.last %},{% endif %}{% endfor %}]{% if not forloop.last %},{% endif %}
    {% endfor %}
};

// Check if referee is unavailable on a given date
function isRefereeUnavailable(refereeId, dateStr) {
    if (!dateStr || !refereeId) return false;
    const unavails = refereeUnavailabilities[refereeId];
    if (!unavails || unavails.length === 0) return false;

    const checkDate = new Date(dateStr);
    checkDate.setHours(0, 0, 0, 0);

    for (const unavail of unavails) {
        const start = new Date(unavail.start);
        const end = new Date(unavail.end);
        start.setHours(0, 0, 0, 0);
        end.setHours(0, 0, 0, 0);
        if (checkDate >= start && checkDate <= end) {
            return true;
        }
    }
    return false;
}
</script>
{% endblock %}

{% block extra_js %}
<script>
let currentMatchId = null;
let currentMatchDate = null;
let currentPhaseSettings = { referee_count: 2, reserve_count: 0, inspector_count: 0 };
let declinedUsersForMatch = new Map();  // Map<userId, declineReason>
let originalAssignedUserIds = [];  // Track original users when sidebar opens (for notification logic)
let hasMatchDetailsChanged = false;  // Track if match details (venue, time, teams) changed since sidebar opened
let saveTimeout = null;

let openDropdown = null;

// Helper function to get all currently assigned user IDs (excluding a specific select element)
function getCurrentlyAssignedUserIds(excludeSelect = null) {
    const assignedIds = new Set();
    const containers = ['refereesContainer', 'reservesContainer', 'inspectorsContainer', 'tournamentDirectorsContainer'];

    containers.forEach(containerId => {
        const container = document.getElementById(containerId);
        if (!container) return;

        container.querySelectorAll('.custom-select').forEach(select => {
            // Skip the select element we're excluding
            if (excludeSelect && select === excludeSelect) return;

            const value = select.dataset.value;
            // Only track real user IDs (not empty or placeholders)
            if (value && !['', 'hianyzik', 'szukseges', 'nincs'].includes(value)) {
                const userId = parseInt(value);
                if (!isNaN(userId)) {
                    assignedIds.add(userId);
                }
            }
        });
    });

    return assignedIds;
}

// ==================== NEW MATCH SIDEBAR ====================

function openNewMatchSidebar(isTournament = false) {
    // Close edit sidebar if open
    closeSidebar();

    // Set default date to today and time to next hour
    const now = new Date();
    const today = now.toISOString().split('T')[0];
    now.setHours(now.getHours() + 1, 0, 0, 0);
    const time = now.toTimeString().slice(0, 5);

    document.getElementById('newMatchDate').value = today;
    document.getElementById('newMatchTime').value = time;
    document.getElementById('newMatchPhase').value = '';
    document.getElementById('newMatchHomeTeam').value = '';
    document.getElementById('newMatchAwayTeam').value = '';
    document.getElementById('newMatchVenue').value = '';
    document.getElementById('newMatchCourt').value = '';
    document.getElementById('newMatchNotes').value = '';
    document.getElementById('newMatchTournamentCount').value = '1';
    document.getElementById('newMatchCourtCount').value = '1';

    // Set tournament mode
    document.getElementById('newMatchIsTournament').value = isTournament ? 'true' : 'false';

    // Update UI based on tournament mode
    const sidebarTitle = document.getElementById('newMatchSidebarTitle');
    const sidebarIcon = document.getElementById('newMatchSidebarIcon');
    const tournamentFieldsGroup = document.getElementById('newMatchTournamentFieldsGroup');
    const awayTeamGroup = document.getElementById('newMatchAwayTeamGroup');
    const homeTeamLabel = document.getElementById('newMatchHomeTeamLabel');

    if (isTournament) {
        sidebarTitle.textContent = 'Új torna';
        sidebarIcon.textContent = 'emoji_events';
        sidebarIcon.style.color = 'var(--info-color)';
        tournamentFieldsGroup.style.display = 'block';
        awayTeamGroup.style.display = 'none';
        homeTeamLabel.textContent = 'Rendező csapat';
    } else {
        sidebarTitle.textContent = 'Új mérkőzés';
        sidebarIcon.textContent = 'add_circle';
        sidebarIcon.style.color = 'var(--success-color)';
        tournamentFieldsGroup.style.display = 'none';
        awayTeamGroup.style.display = 'block';
        homeTeamLabel.textContent = 'Hazai csapat';
    }

    // Show sidebar
    document.getElementById('newMatchSidebar').classList.add('open');
}

function closeNewMatchSidebar() {
    document.getElementById('newMatchSidebar').classList.remove('open');
}

function toggleEditMatchTournamentMode(isTournament) {
    const tournamentFieldsGroup = document.getElementById('editMatchTournamentFieldsGroup');
    const awayTeamGroup = document.getElementById('editMatchAwayTeamGroup');
    const homeTeamLabel = document.getElementById('editMatchHomeTeamLabel');

    if (isTournament) {
        tournamentFieldsGroup.style.display = 'block';
        awayTeamGroup.style.display = 'none';
        homeTeamLabel.textContent = 'Rendező csapat';
        // Clear away team and save
        setMatchDataSelectValue('AwayTeam', '', '-- Nincs megadva --');
        saveMatchField('away_team_id', null);
    } else {
        tournamentFieldsGroup.style.display = 'none';
        awayTeamGroup.style.display = 'block';
        homeTeamLabel.textContent = 'Hazai csapat';
    }
    // Save tournament mode
    saveMatchField('is_tournament', isTournament);
}

function createNewMatch() {
    const date = document.getElementById('newMatchDate').value;
    const time = document.getElementById('newMatchTime').value;

    if (!date || !time) {
        showToast('Dátum és időpont megadása kötelező!', true);
        return;
    }

    const isTournament = document.getElementById('newMatchIsTournament').value === 'true';
    const tournamentMatchCount = document.getElementById('newMatchTournamentCount').value || 1;
    const tournamentCourtCount = document.getElementById('newMatchCourtCount').value || 1;

    const data = {
        date: date,
        time: time,
        phase: document.getElementById('newMatchPhase').value || null,
        home_team: document.getElementById('newMatchHomeTeam').value || null,
        away_team: isTournament ? null : (document.getElementById('newMatchAwayTeam').value || null),
        venue: document.getElementById('newMatchVenue').value || null,
        court: document.getElementById('newMatchCourt').value,
        notes: document.getElementById('newMatchNotes').value,
        is_tournament: isTournament,
        tournament_match_count: isTournament ? parseInt(tournamentMatchCount) : 1,
        tournament_court_count: isTournament ? parseInt(tournamentCourtCount) : 1
    };

    fetch('/matches/api/match/create/', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': '{{ csrf_token }}'
        },
        body: JSON.stringify(data)
    })
    .then(response => response.json())
    .then(result => {
        if (result.success) {
            showToast('Mérkőzés létrehozva!');
            closeNewMatchSidebar();
            // Reload page to show new match
            window.location.reload();
        } else {
            showToast(result.error || 'Hiba történt!', true);
        }
    })
    .catch(error => {
        showToast('Hiba történt!', true);
        console.error(error);
    });
}

// ==================== TOGGLE FUNCTIONS ====================

function toggleMatchHidden(matchId) {
    fetch(`/matches/api/match/${matchId}/toggle-hidden/`, {
        method: 'POST',
        headers: {
            'X-CSRFToken': '{{ csrf_token }}'
        }
    })
    .then(response => response.json())
    .then(result => {
        if (result.success) {
            const card = document.querySelector(`.match-card[data-match-id="${matchId}"]`);
            const btn = card.querySelector('.match-action-btn.toggle-hidden-btn');
            const icon = btn.querySelector('.material-icons');

            if (result.is_hidden) {
                card.classList.add('is-hidden');
                card.dataset.isHidden = 'true';
                btn.classList.add('active');
                icon.textContent = 'visibility_off';
                showToast('Mérkőzés elrejtve');
            } else {
                card.classList.remove('is-hidden');
                card.dataset.isHidden = 'false';
                btn.classList.remove('active');
                icon.textContent = 'visibility';
                showToast('Mérkőzés látható');
            }
        }
    });
}

function toggleAssignmentPublished(matchId) {
    fetch(`/matches/api/match/${matchId}/toggle-assignment-published/`, {
        method: 'POST',
        headers: {
            'X-CSRFToken': '{{ csrf_token }}'
        }
    })
    .then(response => response.json())
    .then(result => {
        if (result.success) {
            const card = document.querySelector(`.match-card[data-match-id="${matchId}"]`);
            const btn = card.querySelector('.match-action-btn.toggle-assignment-btn');
            const icon = btn.querySelector('.material-icons');
            const refRow = card.querySelector('.match-referees-row');
            const statusBadge = card.querySelector('.match-status-badge');

            if (result.is_assignment_published) {
                card.classList.remove('assignment-unpublished');
                card.dataset.isAssignmentPublished = 'true';
                btn.classList.remove('active');
                icon.textContent = 'person';
                showToast('Kiírás publikálva');
                // Reload to show referees
                window.location.reload();
            } else {
                card.classList.add('assignment-unpublished');
                card.dataset.isAssignmentPublished = 'false';
                btn.classList.add('active');
                icon.textContent = 'person_off';
                refRow.innerHTML = '<div class="unpublished-notice"><span class="material-icons">visibility_off</span>Még nincs kiírás erre a mérkőzésre</div>';
                // Update status badge if status changed to draft
                if (result.status === 'draft') {
                    card.classList.remove('status-scheduled', 'status-confirmed');
                    card.classList.add('status-draft');
                    statusBadge.className = 'match-status-badge draft';
                    statusBadge.innerHTML = '<span class="material-icons">edit</span> Piszkozat';
                }
                showToast('Kiírás elrejtve');
            }
        }
    });
}

function toggleMatchCancelled(matchId) {
    fetch(`/matches/api/match/${matchId}/toggle-cancelled/`, {
        method: 'POST',
        headers: {
            'X-CSRFToken': '{{ csrf_token }}'
        }
    })
    .then(response => response.json())
    .then(result => {
        if (result.success) {
            const card = document.querySelector(`.match-card[data-match-id="${matchId}"]`);
            const btn = card.querySelector('.match-action-btn.toggle-cancelled-btn');
            const icon = btn.querySelector('.material-icons');
            const statusBadge = card.querySelector('.match-status-badge');
            const timeSpan = card.querySelector('.match-time');

            if (result.is_cancelled) {
                card.classList.add('status-cancelled');
                card.classList.remove('status-draft', 'status-scheduled', 'status-confirmed', 'status-incomplete');
                btn.classList.add('active');
                icon.textContent = 'flag';
                statusBadge.className = 'match-status-badge cancelled';
                statusBadge.innerHTML = '<span class="material-icons">cancel</span> Elmarad';
                if (timeSpan) timeSpan.textContent = '-';

                // Update assignment toggle (emberke) - hide assignments
                const assignmentBtn = card.querySelector('.toggle-assignment-btn');
                if (assignmentBtn) {
                    assignmentBtn.classList.add('active');
                    const assignIcon = assignmentBtn.querySelector('.material-icons');
                    if (assignIcon) assignIcon.textContent = 'person_off';
                }

                // Update hidden toggle (szem) - hide match
                const hiddenBtn = card.querySelector('.toggle-hidden-btn');
                if (hiddenBtn) {
                    hiddenBtn.classList.add('active');
                    const hiddenIcon = hiddenBtn.querySelector('.material-icons');
                    if (hiddenIcon) hiddenIcon.textContent = 'visibility_off';
                }

                // Remove referees display
                const refRow = card.querySelector('.match-referees-row');
                if (refRow) {
                    refRow.innerHTML = '<div class="referee-item" style="color: var(--text-secondary);"><span class="material-icons" style="font-size: 1rem;">person_off</span><span>Nincs játékvezető kijelölve</span></div>';
                }

                showToast('Mérkőzés elmarad - meccs és kiírás elrejtve');
            } else {
                card.classList.remove('status-cancelled');
                card.classList.add('status-draft');
                btn.classList.remove('active');
                icon.textContent = 'outlined_flag';
                statusBadge.className = 'match-status-badge draft';
                statusBadge.innerHTML = '<span class="material-icons">edit</span> Piszkozat';

                // Restore hidden toggle (szem) - make match visible again
                const hiddenBtn = card.querySelector('.toggle-hidden-btn');
                if (hiddenBtn) {
                    hiddenBtn.classList.remove('active');
                    const hiddenIcon = hiddenBtn.querySelector('.material-icons');
                    if (hiddenIcon) hiddenIcon.textContent = 'visibility';
                }

                showToast('Mérkőzés visszaállítva - szerkeszthető');
            }
        }
    });
}

function deleteMatchDirect(matchId) {
    if (!confirm('Biztosan törölni szeretnéd ezt a mérkőzést?')) {
        return;
    }

    fetch(`/matches/api/match/${matchId}/delete/`, {
        method: 'POST',
        headers: {
            'X-CSRFToken': '{{ csrf_token }}'
        }
    })
    .then(response => response.json())
    .then(result => {
        if (result.success) {
            showToast('Mérkőzés törölve');
            // Remove card from DOM
            const card = document.querySelector(`.match-card[data-match-id="${matchId}"]`);
            if (card) {
                card.remove();
            }
            closeSidebar();
        } else {
            showToast(result.error || 'Hiba történt!', true);
        }
    });
}

// ==================== MATCH DATA SIDEBAR ====================

let editingMatchId = null;
let matchDataDropdownOpen = null;

function toggleMatchDataDropdown(selectEl) {
    const dropdown = selectEl.nextElementSibling;
    const isOpen = dropdown.classList.contains('show');

    // Close all other dropdowns
    document.querySelectorAll('#matchDataSidebar .custom-select-dropdown.show').forEach(d => {
        d.classList.remove('show');
        d.previousElementSibling.classList.remove('open');
    });

    if (!isOpen) {
        dropdown.classList.add('show');
        selectEl.classList.add('open');
        matchDataDropdownOpen = dropdown;
        // Focus search input
        const searchInput = dropdown.querySelector('.custom-select-search input');
        if (searchInput) searchInput.focus();
    } else {
        matchDataDropdownOpen = null;
    }
}

function selectMatchDataOption(optionEl, field) {
    const dropdown = optionEl.closest('.custom-select-dropdown');
    const selectEl = dropdown.previousElementSibling;
    const value = optionEl.dataset.value;
    const text = optionEl.textContent.trim();
    const isTbd = optionEl.dataset.isTbd === 'true';

    selectEl.dataset.value = value;
    const valueSpan = selectEl.querySelector('.custom-select-value');

    if (value === '') {
        valueSpan.textContent = '-- Nincs megadva --';
        valueSpan.classList.add('placeholder');
        valueSpan.style.color = '';
    } else if (isTbd) {
        valueSpan.innerHTML = '<span class="material-icons" style="font-size: 1rem; vertical-align: middle; margin-right: 0.25rem;">help_outline</span>' + text;
        valueSpan.classList.remove('placeholder');
        valueSpan.style.color = 'var(--warning-color)';
    } else {
        valueSpan.textContent = text;
        valueSpan.classList.remove('placeholder');
        valueSpan.style.color = '';
    }

    // Mark selected
    dropdown.querySelectorAll('.custom-select-option').forEach(o => o.classList.remove('selected'));
    optionEl.classList.add('selected');

    // Close dropdown
    dropdown.classList.remove('show');
    selectEl.classList.remove('open');
    matchDataDropdownOpen = null;
}

function filterMatchDataOptions(inputEl, field) {
    const searchValue = inputEl.value.toLowerCase();
    const options = inputEl.closest('.custom-select-dropdown').querySelectorAll('.custom-select-options .custom-select-option');

    options.forEach(option => {
        const text = option.textContent.toLowerCase();
        option.style.display = text.includes(searchValue) ? 'block' : 'none';
    });
}

function setMatchDataSelectValue(field, value, text) {
    const wrapper = document.getElementById(`editMatch${field.charAt(0).toUpperCase() + field.slice(1)}Wrapper`);
    if (!wrapper) return;

    const selectEl = wrapper.querySelector('.custom-select');
    const valueSpan = selectEl.querySelector('.custom-select-value');

    selectEl.dataset.value = value || '';

    if (!value) {
        valueSpan.textContent = '-- Nincs megadva --';
        valueSpan.classList.add('placeholder');
        valueSpan.style.color = '';
    } else {
        // Find the option to check if it's TBD
        const option = wrapper.querySelector(`.custom-select-option[data-value="${value}"]`);
        const isTbd = option && option.dataset.isTbd === 'true';

        if (isTbd) {
            valueSpan.innerHTML = '<span class="material-icons" style="font-size: 1rem; vertical-align: middle; margin-right: 0.25rem;">help_outline</span>' + (text || 'TBD');
            valueSpan.style.color = 'var(--warning-color)';
        } else {
            valueSpan.textContent = text || value;
            valueSpan.style.color = '';
        }
        valueSpan.classList.remove('placeholder');
    }

    // Mark selected option
    wrapper.querySelectorAll('.custom-select-option').forEach(o => {
        o.classList.toggle('selected', o.dataset.value === (value || ''));
    });
}

function openMatchDataSidebar(matchId) {
    // Close other sidebars
    closeNewMatchSidebar();
    closeSidebar();

    editingMatchId = matchId;

    // Load match data
    fetch(`/matches/api/match/${matchId}/`)
        .then(response => response.json())
        .then(data => {
            document.getElementById('editMatchDate').value = data.date || '';
            document.getElementById('editMatchTime').value = data.time || '';

            // Set custom select values
            setMatchDataSelectValue('Phase', data.phase_id, data.phase_name);
            setMatchDataSelectValue('HomeTeam', data.home_team_id, data.home_team_name);
            setMatchDataSelectValue('AwayTeam', data.away_team_id, data.away_team_name);
            setMatchDataSelectValue('Venue', data.venue_id, data.venue_name);

            document.getElementById('editMatchCourt').value = data.court || '';

            // Set tournament mode
            const isTournament = data.is_tournament || false;
            document.getElementById('editMatchIsTournament').checked = isTournament;
            document.getElementById('editMatchTournamentCount').value = data.tournament_match_count || 1;
            document.getElementById('editMatchCourtCount').value = data.tournament_court_count || 1;

            // Update UI for tournament mode without saving (just visual)
            const tournamentFieldsGroup = document.getElementById('editMatchTournamentFieldsGroup');
            const awayTeamGroup = document.getElementById('editMatchAwayTeamGroup');
            const homeTeamLabel = document.getElementById('editMatchHomeTeamLabel');

            if (isTournament) {
                tournamentFieldsGroup.style.display = 'block';
                awayTeamGroup.style.display = 'none';
                homeTeamLabel.textContent = 'Rendező csapat';
            } else {
                tournamentFieldsGroup.style.display = 'none';
                awayTeamGroup.style.display = 'block';
                homeTeamLabel.textContent = 'Hazai csapat';
            }

            // Set MFSZ declaration override
            const mfszOverrideSelect = document.getElementById('editMatchMfszOverride');
            if (data.mfsz_declaration_override === null || data.mfsz_declaration_override === undefined) {
                mfszOverrideSelect.value = '';
            } else {
                mfszOverrideSelect.value = data.mfsz_declaration_override ? 'true' : 'false';
            }
        });

    document.getElementById('matchDataSidebar').classList.add('open');
}

function closeMatchDataSidebar() {
    document.getElementById('matchDataSidebar').classList.remove('open');
    editingMatchId = null;
    // Close any open dropdowns
    document.querySelectorAll('#matchDataSidebar .custom-select-dropdown.show').forEach(d => {
        d.classList.remove('show');
        d.previousElementSibling.classList.remove('open');
    });
}

function getMatchDataSelectValue(field) {
    const wrapper = document.getElementById(`editMatch${field}Wrapper`);
    if (!wrapper) return null;
    const value = wrapper.querySelector('.custom-select').dataset.value;
    return value || null;
}

function saveMatchData(sendEmail = false) {
    if (!editingMatchId) return;

    const data = {
        date: document.getElementById('editMatchDate').value || null,
        time: document.getElementById('editMatchTime').value || null,
        phase_id: getMatchDataSelectValue('Phase'),
        home_team_id: getMatchDataSelectValue('HomeTeam'),
        away_team_id: getMatchDataSelectValue('AwayTeam'),
        venue_id: getMatchDataSelectValue('Venue'),
        court: document.getElementById('editMatchCourt').value,
        send_email: sendEmail
    };

    fetch(`/matches/api/match/${editingMatchId}/update/`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': '{{ csrf_token }}'
        },
        body: JSON.stringify(data)
    })
    .then(response => response.json())
    .then(result => {
        if (result.success) {
            showToast(sendEmail ? 'Mérkőzés adatok mentve és e-mail elküldve!' : 'Mérkőzés adatok mentve!');
            closeMatchDataSidebar();
            window.location.reload();
        } else {
            showToast(result.error || 'Hiba történt!', true);
        }
    });
}

// ==================== ASSIGNMENT SIDEBAR ====================

function openAssignmentSidebar(matchId) {
    // Close other sidebars
    closeNewMatchSidebar();
    closeMatchDataSidebar();

    currentMatchId = matchId;

    // Mark selected card
    document.querySelectorAll('.match-card').forEach(card => card.classList.remove('selected'));
    document.querySelector(`.match-card[data-match-id="${matchId}"]`).classList.add('selected');

    // Show sidebar
    document.getElementById('sidebarPanel').classList.add('open');

    // Load match data
    loadMatchData(matchId);
}

function closeSidebar() {
    document.getElementById('sidebarPanel').classList.remove('open');
    document.querySelectorAll('.match-card').forEach(card => card.classList.remove('selected'));
    currentMatchId = null;
}

function loadMatchData(matchId, isRefresh = false) {
    fetch(`/matches/api/match/${matchId}/`)
        .then(response => response.json())
        .then(data => {
            // Update hidden field
            document.getElementById('currentMatchId').value = data.id;

            // Store match date for unavailability checks
            currentMatchDate = data.date;

            // Collect all declined users for this match with their decline reasons
            declinedUsersForMatch = new Map();
            [...(data.referees || []), ...(data.reserves || []), ...(data.inspectors || []), ...(data.tournament_directors || [])].forEach(a => {
                if (a.response_status === 'declined' && a.user_id) {
                    declinedUsersForMatch.set(a.user_id, a.decline_reason || '');
                }
            });

            // Capture original assigned user IDs (non-declined) for notification logic
            // This tracks who was assigned BEFORE this editing session started
            // Only set on initial load, NOT on refresh (auto-save refresh would include newly added users)
            if (!isRefresh) {
                originalAssignedUserIds = [...(data.referees || []), ...(data.reserves || []), ...(data.inspectors || []), ...(data.tournament_directors || [])]
                    .filter(a => a.user_id && a.response_status !== 'declined')
                    .map(a => a.user_id);
                // Reset match details change tracker
                hasMatchDetailsChanged = false;
            }

            // Update summary
            document.getElementById('summaryHomeTeam').textContent = data.home_team_name || '?';
            document.getElementById('summaryAwayTeam').textContent = data.away_team_name || '?';
            document.getElementById('summaryDate').textContent = formatDate(data.date);
            document.getElementById('summaryTime').textContent = data.time;
            document.getElementById('summaryVenue').textContent = data.venue_name || '-';

            // Update notes
            document.getElementById('matchNotes').value = data.notes || '';

            // Update badge
            const badge = document.getElementById('sidebarCompBadge');
            if (data.phase_id) {
                badge.style.display = 'inline';
                badge.style.background = data.competition_color;
                badge.style.color = 'white';
                badge.textContent = data.phase_name ? data.phase_name.split(' - ')[0] : '';
            } else {
                badge.style.display = 'none';
            }

            // Update button visibility based on status
            const saveDraftBtn = document.getElementById('saveDraftBtn');
            const publishBtn = document.getElementById('publishBtn');
            const publishEmailBtn = document.getElementById('publishEmailBtn');
            const saveNoEmailBtn = document.getElementById('saveNoEmailBtn');
            const saveWithEmailBtn = document.getElementById('saveWithEmailBtn');

            if (data.status === 'draft') {
                saveDraftBtn.style.display = 'inline-flex';
                publishBtn.style.display = 'inline-flex';
                publishEmailBtn.style.display = 'inline-flex';
                saveNoEmailBtn.style.display = 'none';
                saveWithEmailBtn.style.display = 'none';
            } else {
                saveDraftBtn.style.display = 'none';
                publishBtn.style.display = 'none';
                publishEmailBtn.style.display = 'none';
                saveNoEmailBtn.style.display = 'inline-flex';
                saveWithEmailBtn.style.display = 'inline-flex';
            }

            // Store phase settings for use in render functions
            currentPhaseSettings = data.phase_settings || { referee_count: 2, reserve_count: 0, inspector_count: 0 };

            // Check if match has any existing assignments (if not, pre-populate based on phase settings)
            const hasExistingAssignments = (data.referees?.length > 0) || (data.reserves?.length > 0) ||
                                           (data.inspectors?.length > 0) || (data.tournament_directors?.length > 0);

            // Load assignments - only pre-populate empty slots for NEW matches (no existing assignments)
            renderReferees(data.referees, hasExistingAssignments ? 0 : currentPhaseSettings.referee_count);
            renderReserves(data.reserves, hasExistingAssignments ? 0 : currentPhaseSettings.reserve_count);
            renderInspectors(data.inspectors, hasExistingAssignments ? 0 : currentPhaseSettings.inspector_count);
            renderTournamentDirectors(data.tournament_directors || []);
        });
}

function formatDate(dateStr) {
    const date = new Date(dateStr);
    const days = ['Vasárnap', 'Hétfő', 'Kedd', 'Szerda', 'Csütörtök', 'Péntek', 'Szombat'];
    return `${date.getFullYear()}.${String(date.getMonth()+1).padStart(2,'0')}.${String(date.getDate()).padStart(2,'0')} (${days[date.getDay()]})`;
}

function renderReferees(referees, requiredCount = 2) {
    const container = document.getElementById('refereesContainer');
    container.innerHTML = '';
    // Filter: only show declined assignments if they have placeholder_type='hianyzik'
    // (Declined without placeholder_type means admin removed the slot, but X icon should persist in dropdown)
    const visibleReferees = referees.filter(ref => {
        if (ref.response_status === 'declined') {
            return ref.placeholder_type === 'hianyzik';
        }
        return true;
    });
    visibleReferees.forEach((ref, index) => {
        let value;
        if (ref.response_status === 'declined') {
            value = 'hianyzik';  // Show as "Hiányzik!" when someone declined
        } else {
            value = ref.user_id || ref.placeholder_type || '';
        }
        container.appendChild(createAssignmentRow('referee', value, ref.response_status, ref.id, null));
    });
    // Pre-populate empty slots up to required count (only for new matches)
    for (let i = visibleReferees.length; i < requiredCount; i++) {
        container.appendChild(createAssignmentRow('referee', '', ''));
    }
}

function renderReserves(reserves, requiredCount = 0) {
    const container = document.getElementById('reservesContainer');
    container.innerHTML = '';
    // Filter: only show declined assignments if they have placeholder_type='hianyzik'
    const visibleReserves = reserves.filter(ref => {
        if (ref.response_status === 'declined') {
            return ref.placeholder_type === 'hianyzik';
        }
        return true;
    });
    visibleReserves.forEach((ref, index) => {
        let value;
        if (ref.response_status === 'declined') {
            value = 'hianyzik';
        } else {
            value = ref.user_id || ref.placeholder_type || '';
        }
        container.appendChild(createAssignmentRow('reserve', value, ref.response_status, ref.id, null));
    });
    // Pre-populate empty slots up to required count (only for new matches)
    for (let i = visibleReserves.length; i < requiredCount; i++) {
        container.appendChild(createAssignmentRow('reserve', '', ''));
    }
}

function renderInspectors(inspectors, requiredCount = 0) {
    const container = document.getElementById('inspectorsContainer');
    container.innerHTML = '';
    // Filter: only show declined assignments if they have placeholder_type='hianyzik'
    const visibleInspectors = inspectors.filter(ref => {
        if (ref.response_status === 'declined') {
            return ref.placeholder_type === 'hianyzik';
        }
        return true;
    });
    visibleInspectors.forEach((ref, index) => {
        let value;
        if (ref.response_status === 'declined') {
            value = 'hianyzik';
        } else {
            value = ref.user_id || ref.placeholder_type || '';
        }
        container.appendChild(createAssignmentRow('inspector', value, ref.response_status, ref.id, null));
    });
    // Pre-populate empty slots up to required count (only for new matches)
    for (let i = visibleInspectors.length; i < requiredCount; i++) {
        container.appendChild(createAssignmentRow('inspector', '', ''));
    }
}

function renderTournamentDirectors(directors) {
    const container = document.getElementById('tournamentDirectorsContainer');
    container.innerHTML = '';
    // Filter: only show declined assignments if they have placeholder_type='hianyzik'
    const visibleDirectors = directors.filter(ref => {
        if (ref.response_status === 'declined') {
            return ref.placeholder_type === 'hianyzik';
        }
        return true;
    });
    visibleDirectors.forEach((ref, index) => {
        let value;
        if (ref.response_status === 'declined') {
            value = 'hianyzik';
        } else {
            value = ref.user_id || ref.placeholder_type || '';
        }
        container.appendChild(createAssignmentRow('tournament_director', value, ref.response_status, ref.id, null));
    });
}

function createAssignmentRow(type, userId, status, assignmentId = null, declineInfo = null) {
    const row = document.createElement('div');
    row.className = 'assignment-row';
    row.dataset.type = type;
    if (assignmentId) row.dataset.assignmentId = assignmentId;

    // Store decline info on the row for later use when re-selecting the same person
    if (declineInfo) {
        row.dataset.declinedUserId = declineInfo.user_id || '';
        row.dataset.declinedUserName = declineInfo.user_name || '';
    }

    // Build special options HTML
    const specialOptions = [
        { value: 'hianyzik', label: 'Hiányzik!', style: 'color: var(--danger-color); font-weight: 600;' },
        { value: 'szukseges', label: 'Szükséges', style: 'color: var(--warning-color); font-weight: 600;' },
        { value: 'nincs', label: 'Nincs', style: 'color: var(--text-secondary);' }
    ];

    // Check if userId is actually a placeholder type
    const isPlaceholder = specialOptions.some(o => o.value === userId);

    let statusIcon = '';
    // Only show status icon for real users who accepted or are pending, not placeholders or declined
    if (!isPlaceholder && status !== 'declined') {
        if (status === 'accepted' && assignmentId) {
            statusIcon = `<span class="material-icons response-status-icon response-accepted clickable" onclick="resetAssignment(${assignmentId}, this)" title="Kattints a visszavonáshoz">check_circle</span>`;
        } else if (status === 'accepted') {
            statusIcon = '<span class="material-icons response-status-icon response-accepted">check_circle</span>';
        } else if (status === 'pending' && assignmentId) {
            statusIcon = `<span class="material-icons response-status-icon response-pending clickable" onclick="acceptAssignment(${assignmentId}, this)" title="Kattints az elfogadáshoz">schedule</span>`;
        } else if (status === 'pending') {
            statusIcon = '<span class="material-icons response-status-icon response-pending">schedule</span>';
        }
    }

    const selectedRef = allReferees.find(r => r.id == userId);
    const displayValue = selectedRef ? selectedRef.name : '';

    // Build decline info HTML if present - show below the dropdown
    let declineHtml = '';
    if (declineInfo && declineInfo.user_name) {
        declineHtml = `<div class="decline-info" style="font-size: 0.8rem; color: var(--danger-color); margin-top: 0.25rem; padding-left: 0;">
            Lemondta: ${declineInfo.user_name}${declineInfo.reason ? ' - ' + declineInfo.reason : ''}
        </div>`;
    }

    // Auto-select "Hiányzik!" if status is declined (only for real users who declined)
    let effectiveUserId = userId;
    if (status === 'declined' && !isPlaceholder) {
        effectiveUserId = 'hianyzik';
    }

    const isSpecialValue = specialOptions.some(o => o.value === effectiveUserId);
    const specialSelected = specialOptions.find(o => o.value === effectiveUserId);
    const selectedRefForDisplay = allReferees.find(r => r.id == effectiveUserId);
    const matchDateForCheck = currentMatchDate || '';
    const selectedIsUnavailable = selectedRefForDisplay && isRefereeUnavailable(selectedRefForDisplay.id, matchDateForCheck);
    const selectedIsDeclined = selectedRefForDisplay && declinedUsersForMatch.has(selectedRefForDisplay.id);
    const selectedDeclineReason = selectedIsDeclined ? declinedUsersForMatch.get(selectedRefForDisplay.id) : '';
    let displayText = selectedRefForDisplay ? selectedRefForDisplay.name : 'Válassz játékvezetőt...';
    let displayStyle = '';
    let displayIcon = '';
    if (specialSelected) {
        displayText = specialSelected.label;
        displayStyle = specialSelected.style;
    } else if (selectedIsDeclined) {
        displayStyle = 'color: #dc2626; font-weight: 600;';
        const declineTitle = selectedDeclineReason ? 'Indok: ' + selectedDeclineReason.replace(/"/g, '&quot;') : 'Lemondta';
        displayIcon = ' <span class="material-icons" style="font-size: 14px; vertical-align: middle; cursor: help;" title="' + declineTitle + '">cancel</span>';
    } else if (selectedIsUnavailable) {
        displayStyle = 'color: #dc2626; font-weight: 600;';
        displayIcon = ' <span class="material-icons" style="font-size: 14px; vertical-align: middle;">event_busy</span>';
    }

    row.innerHTML = `
        ${statusIcon}
        <div class="custom-select-wrapper" style="flex: 1;">
            <div class="custom-select" onclick="toggleDropdown(this)" data-value="${effectiveUserId || ''}">
                <span class="custom-select-value ${!effectiveUserId ? 'placeholder' : ''}" style="${displayStyle}">${displayText}${displayIcon}</span>
                <span class="material-icons custom-select-arrow">expand_more</span>
            </div>
            <div class="custom-select-dropdown">
                <div class="custom-select-search">
                    <input type="text" placeholder="Keresés..." oninput="filterOptions(this)">
                </div>
                <div class="custom-select-options">
                    <div class="custom-select-option" data-value="" onclick="selectOption(this)">-- Nincs kiválasztva --</div>
                    <div class="custom-select-option ${effectiveUserId === 'hianyzik' ? 'selected' : ''}" data-value="hianyzik" data-special="true" style="color: var(--danger-color); font-weight: 600; border-bottom: 1px solid var(--border-color);" onclick="selectOption(this)">Hiányzik!</div>
                    <div class="custom-select-option ${effectiveUserId === 'szukseges' ? 'selected' : ''}" data-value="szukseges" data-special="true" style="color: var(--warning-color); font-weight: 600;" onclick="selectOption(this)">Szükséges</div>
                    <div class="custom-select-option ${effectiveUserId === 'nincs' ? 'selected' : ''}" data-value="nincs" data-special="true" style="color: var(--text-secondary); border-bottom: 1px solid var(--border-color); margin-bottom: 0.5rem;" onclick="selectOption(this)">Nincs</div>
                    ${allReferees.map(r => {
                        const matchDate = currentMatchDate || '';
                        const isUnavail = isRefereeUnavailable(r.id, matchDate);
                        const isDeclined = declinedUsersForMatch.has(r.id);
                        const declineReason = isDeclined ? declinedUsersForMatch.get(r.id) : '';
                        let style = '';
                        let suffix = '';
                        let titleAttr = '';
                        let dataAlreadyAssigned = '';
                        if (isDeclined) {
                            style = 'color: #dc2626; font-weight: 600;';
                            suffix = ' <span class="material-icons" style="font-size: 14px; vertical-align: middle; cursor: help;" title="' + (declineReason ? 'Indok: ' + declineReason.replace(/"/g, '&quot;') : 'Lemondta') + '">cancel</span>';
                        } else if (isUnavail) {
                            style = 'color: #dc2626; font-weight: 600;';
                            suffix = ' <span class="material-icons" style="font-size: 14px; vertical-align: middle;">event_busy</span>';
                        }
                        // Note: Already-assigned check will be done dynamically when dropdown opens
                        return `<div class="custom-select-option ${r.id == effectiveUserId ? 'selected' : ''}" data-value="${r.id}" style="${style}" onclick="selectOption(this)">${r.name}${suffix}</div>`;
                    }).join('')}
                </div>
            </div>
        </div>
        <button type="button" class="remove-btn" onclick="removeAssignmentRow(this)">
            <span class="material-icons" style="font-size: 1rem;">close</span>
        </button>
    `;

    // Append decline info after the row if present
    if (declineHtml) {
        const wrapper = document.createElement('div');
        wrapper.className = 'assignment-row-wrapper';
        wrapper.appendChild(row);
        const declineDiv = document.createElement('div');
        declineDiv.innerHTML = declineHtml;
        wrapper.appendChild(declineDiv.firstChild);
        return wrapper;
    }

    return row;
}

function toggleDropdown(selectEl) {
    const dropdown = selectEl.nextElementSibling;
    const isOpen = dropdown.classList.contains('show');

    // Close any open dropdown
    closeAllDropdowns();

    if (!isOpen) {
        selectEl.classList.add('open');
        dropdown.classList.add('show');
        openDropdown = dropdown;

        // Update already-assigned styling for all options
        const currentlyAssigned = getCurrentlyAssignedUserIds(selectEl);
        dropdown.querySelectorAll('.custom-select-option').forEach(opt => {
            const value = opt.dataset.value;
            if (value && !['', 'hianyzik', 'szukseges', 'nincs'].includes(value) && opt.dataset.special !== 'true') {
                const userId = parseInt(value);
                const isAssigned = currentlyAssigned.has(userId);
                const isDeclined = declinedUsersForMatch.has(userId);
                const isUnavail = isRefereeUnavailable(userId, currentMatchDate || '');

                // Find the referee name
                const ref = allReferees.find(r => r.id === userId);
                const name = ref ? ref.name : '';

                // Reset and rebuild the option content and style
                if (isAssigned && !isDeclined && !isUnavail) {
                    // Already assigned to another position - show in yellow/orange
                    opt.style.cssText = 'color: #d97706; font-weight: 600; background: rgba(217, 119, 6, 0.1);';
                    opt.innerHTML = name + ' <span class="material-icons" style="font-size: 14px; vertical-align: middle;">person</span>';
                    opt.dataset.alreadyAssigned = 'true';
                } else if (isDeclined) {
                    opt.style.cssText = 'color: #dc2626; font-weight: 600;';
                    const declineReason = declinedUsersForMatch.get(userId) || '';
                    const declineTitle = declineReason ? 'Indok: ' + declineReason.replace(/"/g, '&quot;') : 'Lemondta';
                    opt.innerHTML = name + ' <span class="material-icons" style="font-size: 14px; vertical-align: middle; cursor: help;" title="' + declineTitle + '">cancel</span>';
                    opt.dataset.alreadyAssigned = 'false';
                } else if (isUnavail) {
                    opt.style.cssText = 'color: #dc2626; font-weight: 600;';
                    opt.innerHTML = name + ' <span class="material-icons" style="font-size: 14px; vertical-align: middle;">event_busy</span>';
                    opt.dataset.alreadyAssigned = 'false';
                } else {
                    opt.style.cssText = '';
                    opt.innerHTML = name;
                    opt.dataset.alreadyAssigned = 'false';
                }
            }
        });

        // Focus search input
        const searchInput = dropdown.querySelector('input');
        if (searchInput) searchInput.focus();
    }
}

function closeAllDropdowns() {
    document.querySelectorAll('.custom-select-dropdown.show').forEach(d => {
        d.classList.remove('show');
        d.previousElementSibling.classList.remove('open');
    });
    openDropdown = null;
}

function selectOption(optionEl) {
    const dropdown = optionEl.closest('.custom-select-dropdown');
    const selectEl = dropdown.previousElementSibling;
    const value = optionEl.dataset.value;
    const text = optionEl.textContent;
    const isSpecial = optionEl.dataset.special === 'true';

    // Only check for real users (not special values)
    if (value && !isSpecial) {
        const userId = parseInt(value);
        const ref = allReferees.find(r => r.id === userId);
        const name = ref ? ref.name : 'ez a személy';
        const matchDate = currentMatchDate || '';

        // Check if user is already assigned to another position on this match
        const currentlyAssigned = getCurrentlyAssignedUserIds(selectEl);
        if (currentlyAssigned.has(userId)) {
            // Don't allow selecting - user is already assigned to another position
            alert(`${name} már ki van írva egy másik pozícióra ezen a mérkőzésen!`);
            closeAllDropdowns();
            return;
        }

        // Check if user declined this match - ask for confirmation
        if (declinedUsersForMatch.has(userId)) {
            const declineReason = declinedUsersForMatch.get(userId);
            const reasonText = declineReason ? `\n\nIndok: ${declineReason}` : '';
            if (!confirm(`Biztos ki akarod írni ${name}-t? Már lemondta ezt a mérkőzést.${reasonText}`)) {
                closeAllDropdowns();
                return;
            }
        }
        // Check if user is unavailable (on vacation) - ask for confirmation
        else if (isRefereeUnavailable(userId, matchDate)) {
            if (!confirm(`Biztos ki akarod írni ${name}-t? Szabadságon van ezen a napon.`)) {
                closeAllDropdowns();
                return;
            }
        }
    }

    // Update select display
    selectEl.dataset.value = value;
    const valueSpan = selectEl.querySelector('.custom-select-value');

    // Get the plain text name (without any icons) from the option
    const plainText = optionEl.childNodes[0]?.textContent?.trim() || text.replace(/<[^>]*>/g, '').trim();

    let displayContent = value ? plainText : 'Válassz játékvezetőt...';
    let displayIcon = '';
    valueSpan.classList.toggle('placeholder', !value);

    // Apply special styling or unavailability/declined styling
    if (isSpecial) {
        valueSpan.style.cssText = optionEl.style.cssText;
    } else if (value && !isSpecial) {
        // Check if selected referee is declined or unavailable
        const matchDate = currentMatchDate || '';
        const userId = parseInt(value);
        const isDeclined = declinedUsersForMatch.has(userId);
        const isUnavail = isRefereeUnavailable(value, matchDate);

        if (isDeclined) {
            valueSpan.style.cssText = 'color: #dc2626; font-weight: 600;';
            const declineReason = declinedUsersForMatch.get(userId) || '';
            const declineTitle = declineReason ? 'Indok: ' + declineReason.replace(/"/g, '&quot;') : 'Lemondta';
            displayIcon = ' <span class="material-icons" style="font-size: 14px; vertical-align: middle; cursor: help;" title="' + declineTitle + '">cancel</span>';
        } else if (isUnavail) {
            valueSpan.style.cssText = 'color: #dc2626; font-weight: 600;';
            displayIcon = ' <span class="material-icons" style="font-size: 14px; vertical-align: middle;">event_busy</span>';
        } else {
            valueSpan.style.cssText = '';
        }
    } else {
        valueSpan.style.cssText = '';
    }

    valueSpan.innerHTML = displayContent + displayIcon;

    // Mark selected
    dropdown.querySelectorAll('.custom-select-option').forEach(o => o.classList.remove('selected'));
    optionEl.classList.add('selected');

    // Close dropdown
    closeAllDropdowns();

    // Mark as unsaved (user must click Save button)
    showSaveStatus('Nincs mentve', true);
}

function filterOptions(inputEl) {
    const searchText = inputEl.value.toLowerCase();
    const options = inputEl.closest('.custom-select-dropdown').querySelectorAll('.custom-select-options .custom-select-option');

    options.forEach(opt => {
        const text = opt.textContent.toLowerCase();
        opt.style.display = text.includes(searchText) ? '' : 'none';
    });
}

function addRefereeRow() {
    const container = document.getElementById('refereesContainer');
    container.appendChild(createAssignmentRow('referee', '', ''));
}

function addReserveRow() {
    const container = document.getElementById('reservesContainer');
    container.appendChild(createAssignmentRow('reserve', '', ''));
}

function addInspectorRow() {
    const container = document.getElementById('inspectorsContainer');
    container.appendChild(createAssignmentRow('inspector', '', ''));
}

function addTournamentDirectorRow() {
    const container = document.getElementById('tournamentDirectorsContainer');
    container.appendChild(createAssignmentRow('tournament_director', '', ''));
}

function removeAssignmentRow(btn) {
    const row = btn.closest('.assignment-row');
    const select = row.querySelector('.custom-select');
    const value = select?.dataset.value || '';

    // Check if there's a real person assigned (not empty or placeholder)
    const placeholders = ['', 'hianyzik', 'szukseges', 'nincs'];
    if (!placeholders.includes(value)) {
        // Find the person's name
        const ref = allReferees.find(r => r.id == value);
        const name = ref ? ref.name : 'ez a személy';
        if (!confirm(`Biztos törölni akarod ezt a pozíciót? ${name} is törlődik a mérkőzésről.`)) {
            return;
        }
    }

    row.remove();
    // Mark as unsaved (user must click Save button)
    showSaveStatus('Nincs mentve', true);
}

function saveMatchField(field, value) {
    if (!currentMatchId) return;

    // Track substantive changes (venue, time, teams) for notification logic
    const substantiveFields = ['date', 'time', 'venue_id', 'home_team_id', 'away_team_id'];
    if (substantiveFields.includes(field)) {
        hasMatchDetailsChanged = true;
    }

    showSaveStatus('Mentés...');

    const data = {};
    data[field] = value || null;

    fetch(`/matches/api/match/${currentMatchId}/update/`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': '{{ csrf_token }}'
        },
        body: JSON.stringify(data)
    })
    .then(response => response.json())
    .then(result => {
        if (result.success) {
            showSaveStatus('Mentve');
        } else {
            showSaveStatus('Hiba!', true);
        }
    })
    .catch(() => {
        showSaveStatus('Hiba!', true);
    });
}

function saveAssignments() {
    if (!currentMatchId) return;

    // Collect assignments - values can be user IDs or placeholder types (hianyzik, szukseges, nincs)
    const referees = [];
    const reserves = [];
    const inspectors = [];
    const tournament_directors = [];

    document.querySelectorAll('#refereesContainer .assignment-row .custom-select').forEach(select => {
        if (select.dataset.value) referees.push(select.dataset.value);
    });
    document.querySelectorAll('#reservesContainer .assignment-row .custom-select').forEach(select => {
        if (select.dataset.value) reserves.push(select.dataset.value);
    });
    document.querySelectorAll('#inspectorsContainer .assignment-row .custom-select').forEach(select => {
        if (select.dataset.value) inspectors.push(select.dataset.value);
    });
    document.querySelectorAll('#tournamentDirectorsContainer .assignment-row .custom-select').forEach(select => {
        if (select.dataset.value) tournament_directors.push(select.dataset.value);
    });

    showSaveStatus('Mentés...');

    fetch(`/matches/api/match/${currentMatchId}/assignments/`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': '{{ csrf_token }}'
        },
        body: JSON.stringify({ referees, reserves, inspectors, tournament_directors, skip_notifications: true })
    })
    .then(response => response.json())
    .then(result => {
        if (result.success) {
            showSaveStatus('Mentve');
            updateMatchCard(currentMatchId);
        } else {
            showSaveStatus('Hiba!', true);
        }
    })
    .catch(() => {
        showSaveStatus('Hiba!', true);
    });
}

function saveDraft() {
    saveAssignments();
    showSaveStatus('Piszkozat mentve');
}

function publishMatch(sendEmail) {
    if (!currentMatchId) return;

    const message = sendEmail
        ? 'Biztosan ki szeretnéd írni a mérkőzést és e-mailt küldeni a játékvezetőknek?'
        : 'Biztosan ki szeretnéd írni a mérkőzést (e-mail nélkül)?';

    if (!confirm(message)) return;

    fetch(`/matches/api/match/${currentMatchId}/publish/`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': '{{ csrf_token }}'
        },
        body: JSON.stringify({ send_email: sendEmail })
    })
    .then(response => response.json())
    .then(result => {
        if (result.success) {
            showSaveStatus('Kiírva');
            document.getElementById('saveDraftBtn').style.display = 'none';
            document.getElementById('publishBtn').style.display = 'none';
            document.getElementById('publishEmailBtn').style.display = 'none';
            updateMatchCard(currentMatchId);
        } else {
            alert(result.error || 'Hiba történt.');
        }
    });
}

function deleteMatch() {
    if (!currentMatchId) return;

    if (!confirm('Biztosan törölni szeretnéd a mérkőzést?')) return;

    fetch(`/matches/api/match/${currentMatchId}/delete/`, {
        method: 'POST',
        headers: {
            'X-CSRFToken': '{{ csrf_token }}'
        }
    })
    .then(response => response.json())
    .then(result => {
        if (result.success) {
            const card = document.querySelector(`.match-card[data-match-id="${currentMatchId}"]`);
            if (card) card.remove();
            closeSidebar();
        }
    });
}

function acceptAssignment(assignmentId, iconEl) {
    if (!confirm('Biztosan elfogadod a kiírást a játékvezető nevében?')) return;

    fetch(`/matches/api/assignment/${assignmentId}/accept/`, {
        method: 'POST',
        headers: {
            'X-CSRFToken': '{{ csrf_token }}'
        }
    })
    .then(response => response.json())
    .then(result => {
        if (result.success) {
            // Update the icon to accepted (clickable to reset)
            iconEl.classList.remove('response-pending');
            iconEl.classList.add('response-accepted');
            iconEl.textContent = 'check_circle';
            iconEl.title = 'Kattints a visszavonáshoz';
            iconEl.onclick = function() { resetAssignment(assignmentId, iconEl); };

            showSaveStatus('Elfogadva');
            updateMatchCard(currentMatchId);
        } else {
            alert(result.error || 'Hiba történt.');
        }
    });
}

function resetAssignment(assignmentId, iconEl) {
    if (!confirm('Biztosan visszavonod az elfogadást?')) return;

    fetch(`/matches/api/assignment/${assignmentId}/reset/`, {
        method: 'POST',
        headers: {
            'X-CSRFToken': '{{ csrf_token }}'
        }
    })
    .then(response => response.json())
    .then(result => {
        if (result.success) {
            // Update the icon to pending (clickable to accept)
            iconEl.classList.remove('response-accepted');
            iconEl.classList.add('response-pending');
            iconEl.textContent = 'schedule';
            iconEl.title = 'Kattints az elfogadáshoz';
            iconEl.onclick = function() { acceptAssignment(assignmentId, iconEl); };

            showSaveStatus('Visszavonva');
            updateMatchCard(currentMatchId);
        } else {
            alert(result.error || 'Hiba történt.');
        }
    });
}

function saveChanges(sendEmail) {
    if (!currentMatchId) return;

    showSaveStatus('Mentés...');

    // Collect assignments only - match data is edited in a separate sidebar
    const referees = [];
    const reserves = [];
    const inspectors = [];
    const tournament_directors = [];

    document.querySelectorAll('#refereesContainer .assignment-row .custom-select').forEach(select => {
        if (select.dataset.value) referees.push(select.dataset.value);
    });
    document.querySelectorAll('#reservesContainer .assignment-row .custom-select').forEach(select => {
        if (select.dataset.value) reserves.push(select.dataset.value);
    });
    document.querySelectorAll('#inspectorsContainer .assignment-row .custom-select').forEach(select => {
        if (select.dataset.value) inspectors.push(select.dataset.value);
    });
    document.querySelectorAll('#tournamentDirectorsContainer .assignment-row .custom-select').forEach(select => {
        if (select.dataset.value) tournament_directors.push(select.dataset.value);
    });

    fetch(`/matches/api/match/${currentMatchId}/assignments/`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': '{{ csrf_token }}'
        },
        body: JSON.stringify({ referees, reserves, inspectors, tournament_directors, send_email: sendEmail, original_assigned_user_ids: originalAssignedUserIds, has_match_details_changed: hasMatchDetailsChanged })
    })
    .then(response => response.json())
    .then(result => {
        if (result.success) {
            showSaveStatus(sendEmail ? 'Mentve és e-mail elküldve' : 'Mentve');
            // Reset match details change tracker after successful save
            hasMatchDetailsChanged = false;
            updateMatchCard(currentMatchId);
            loadMatchData(currentMatchId, true); // Refresh the sidebar (isRefresh=true to preserve originalAssignedUserIds)
        } else {
            showSaveStatus('Hiba!', true);
        }
    })
    .catch(() => {
        showSaveStatus('Hiba!', true);
    });
}

function showSaveStatus(text, isError = false) {
    showToast(text, isError);
}

function showToast(text, isError = false) {
    // Get or create toast element
    let toast = document.getElementById('toastNotification');
    if (!toast) {
        toast = document.createElement('div');
        toast.id = 'toastNotification';
        toast.className = 'toast-notification';
        document.body.appendChild(toast);
    }

    // Set content and style
    const icon = isError ? 'error' : 'check_circle';
    toast.innerHTML = `<span class="material-icons">${icon}</span><span>${text}</span>`;
    toast.className = 'toast-notification ' + (isError ? 'error' : 'success');

    // Show toast
    setTimeout(() => toast.classList.add('show'), 10);

    // Hide after delay
    clearTimeout(saveTimeout);
    saveTimeout = setTimeout(() => {
        toast.classList.remove('show');
    }, isError ? 3000 : 2000);
}

function updateMatchCard(matchId) {
    // Reload the page to update the card (simple solution)
    // In production, you'd update the card DOM directly
    fetch(`/matches/api/match/${matchId}/`)
        .then(response => response.json())
        .then(data => {
            const card = document.querySelector(`.match-card[data-match-id="${matchId}"]`);
            if (!card) return;

            // Placeholder labels
            const placeholderLabels = {
                'hianyzik': 'Hiányzik!',
                'szukseges': 'Szükséges',
                'nincs': 'Nincs'
            };
            const placeholderStyles = {
                'hianyzik': 'color: var(--danger-color); font-weight: 600;',
                'szukseges': 'color: var(--warning-color); font-weight: 600;',
                'nincs': 'color: var(--text-secondary);'
            };

            // Update status class
            card.className = `match-card status-${data.status} selected`;

            // Update referees row
            const refRow = card.querySelector('.match-referees-row');
            let refHtml = '';

            // Filter: only show declined assignments if they have placeholder_type='hianyzik'
            const filterVisible = (arr) => arr.filter(r => {
                if (r.response_status === 'declined') {
                    return r.placeholder_type === 'hianyzik';
                }
                return true;
            });

            const visibleReferees = filterVisible(data.referees);
            const visibleReserves = filterVisible(data.reserves);
            const visibleInspectors = filterVisible(data.inspectors);
            const visibleDirectors = filterVisible(data.tournament_directors || []);

            if (visibleReferees.length === 0 && visibleReserves.length === 0 && visibleInspectors.length === 0) {
                refHtml = `<div class="referee-item" style="color: var(--text-secondary);">
                    <span class="material-icons" style="font-size: 1rem;">person_off</span>
                    <span>Nincs játékvezető kijelölve</span>
                </div>`;
            } else {
                visibleReferees.forEach(r => {
                    if (r.response_status === 'declined' && r.placeholder_type === 'hianyzik') {
                        // Declined with hianyzik placeholder - show as "Hiányzik!"
                        refHtml += `<div class="referee-item">
                            <span class="referee-role">Játékvezető</span>
                            <span class="referee-name" style="${placeholderStyles['hianyzik']}">${placeholderLabels['hianyzik']}</span>
                        </div>`;
                    } else if (r.placeholder_type && placeholderLabels[r.placeholder_type]) {
                        // Placeholder - no status icon
                        refHtml += `<div class="referee-item">
                            <span class="referee-role">Játékvezető</span>
                            <span class="referee-name" style="${placeholderStyles[r.placeholder_type]}">${placeholderLabels[r.placeholder_type]}</span>
                        </div>`;
                    } else if (r.user_name) {
                        const icon = r.response_status === 'accepted' ? 'check_circle' : r.response_status === 'declined' ? 'cancel' : 'schedule';
                        refHtml += `<div class="referee-item">
                            <span class="material-icons response-status-icon response-${r.response_status}">${icon}</span>
                            <span class="referee-role">Játékvezető</span>
                            <span class="referee-name">${r.user_name}</span>
                        </div>`;
                    }
                });
                visibleReserves.forEach(r => {
                    if (r.response_status === 'declined' && r.placeholder_type === 'hianyzik') {
                        refHtml += `<div class="referee-item">
                            <span class="referee-role">Tartalék</span>
                            <span class="referee-name" style="${placeholderStyles['hianyzik']}">${placeholderLabels['hianyzik']}</span>
                        </div>`;
                    } else if (r.placeholder_type && placeholderLabels[r.placeholder_type]) {
                        refHtml += `<div class="referee-item">
                            <span class="referee-role">Tartalék</span>
                            <span class="referee-name" style="${placeholderStyles[r.placeholder_type]}">${placeholderLabels[r.placeholder_type]}</span>
                        </div>`;
                    } else if (r.user_name) {
                        const icon = r.response_status === 'accepted' ? 'check_circle' : r.response_status === 'declined' ? 'cancel' : 'schedule';
                        refHtml += `<div class="referee-item">
                            <span class="material-icons response-status-icon response-${r.response_status}">${icon}</span>
                            <span class="referee-role">Tartalék</span>
                            <span class="referee-name">${r.user_name}</span>
                        </div>`;
                    }
                });
                visibleInspectors.forEach(r => {
                    if (r.response_status === 'declined' && r.placeholder_type === 'hianyzik') {
                        refHtml += `<div class="referee-item">
                            <span class="referee-role">Ellenőr</span>
                            <span class="referee-name" style="${placeholderStyles['hianyzik']}">${placeholderLabels['hianyzik']}</span>
                        </div>`;
                    } else if (r.placeholder_type && placeholderLabels[r.placeholder_type]) {
                        refHtml += `<div class="referee-item">
                            <span class="referee-role">Ellenőr</span>
                            <span class="referee-name" style="${placeholderStyles[r.placeholder_type]}">${placeholderLabels[r.placeholder_type]}</span>
                        </div>`;
                    } else if (r.user_name) {
                        const icon = r.response_status === 'accepted' ? 'check_circle' : r.response_status === 'declined' ? 'cancel' : 'schedule';
                        refHtml += `<div class="referee-item">
                            <span class="material-icons response-status-icon response-${r.response_status}">${icon}</span>
                            <span class="referee-role">Ellenőr</span>
                            <span class="referee-name">${r.user_name}</span>
                        </div>`;
                    }
                });
                visibleDirectors.forEach(r => {
                    if (r.response_status === 'declined' && r.placeholder_type === 'hianyzik') {
                        refHtml += `<div class="referee-item">
                            <span class="referee-role">Tornaig.</span>
                            <span class="referee-name" style="${placeholderStyles['hianyzik']}">${placeholderLabels['hianyzik']}</span>
                        </div>`;
                    } else if (r.placeholder_type && placeholderLabels[r.placeholder_type]) {
                        refHtml += `<div class="referee-item">
                            <span class="referee-role">Tornaig.</span>
                            <span class="referee-name" style="${placeholderStyles[r.placeholder_type]}">${placeholderLabels[r.placeholder_type]}</span>
                        </div>`;
                    } else if (r.user_name) {
                        const icon = r.response_status === 'accepted' ? 'check_circle' : r.response_status === 'declined' ? 'cancel' : 'schedule';
                        refHtml += `<div class="referee-item">
                            <span class="material-icons response-status-icon response-${r.response_status}">${icon}</span>
                            <span class="referee-role">Tornaig.</span>
                            <span class="referee-name">${r.user_name}</span>
                        </div>`;
                    }
                });
            }
            refRow.innerHTML = refHtml;

            // Update status badge
            const statusBadge = card.querySelector('.match-status-badge');
            statusBadge.className = `match-status-badge ${data.status}`;
            if (data.status === 'draft') {
                statusBadge.innerHTML = '<span class="material-icons">edit</span> Piszkozat';
            } else if (data.status === 'scheduled') {
                statusBadge.innerHTML = '<span class="material-icons">schedule</span> Kiírva';
            } else if (data.status === 'confirmed') {
                statusBadge.innerHTML = '<span class="material-icons">check_circle</span> Visszaigazolva';
            }

            // Update confirmation count
            const confirmCount = card.querySelector('.confirmation-count');
            if (confirmCount && data.is_assignment_published) {
                const requiredCount = data.phase_settings?.referee_count || 2;
                // Count accepted referees (not declined, not placeholders)
                const confirmedCount = visibleReferees.filter(r =>
                    r.response_status === 'accepted' && r.user_id
                ).length;
                // Only show declined indicator for visible declined (those with placeholder_type='hianyzik')
                const hasDeclined = visibleReferees.some(r => r.response_status === 'declined' && r.placeholder_type === 'hianyzik');

                confirmCount.className = `confirmation-count${hasDeclined ? ' has-declined' : ''}`;

                let icon = '';
                if (hasDeclined) {
                    icon = '<span class="material-icons" style="color: #dc2626;">cancel</span>';
                } else if (confirmedCount >= requiredCount) {
                    icon = '<span class="material-icons" style="color: #16a34a;">check_circle</span>';
                } else {
                    icon = '<span class="material-icons" style="color: #ca8a04;">pending</span>';
                }

                confirmCount.innerHTML = `<span>${confirmedCount}&nbsp;/&nbsp;${requiredCount}</span> ${icon}`;
            }
        });
}

// Close dropdown when clicking outside
document.addEventListener('click', function(e) {
    if (!e.target.closest('.custom-select-wrapper')) {
        closeAllDropdowns();
    }
});

// Close sidebar on Escape key
document.addEventListener('keydown', function(e) {
    if (e.key === 'Escape') {
        if (openDropdown) {
            closeAllDropdowns();
        } else {
            closeSidebar();
        }
    }
});
</script>
{% endblock %}
